{% load static %}

<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tell us your criteria</title>
  <!-- use bootstrap UI -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <!-- base layout -->
  <link rel="stylesheet" href="{% static 'css/sharedsteps.css' %}" />
  <script src="https://kit.fontawesome.com/95a71e9646.js" crossorigin="anonymous"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="{% static 'js/jquery-3.7.1.js'%}"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>

<body class="h-screen w-screen overflow-y-hidden flex flex-col">

    <!-- 
      The <noscript> tag encloses the content that will be displayed 
      only if JavaScript is disabled or not supported in the user's browser. 
    -->
    <noscript>
        If you see this text, your browser does not support dynamic content
        (JavaScript) or it has been disabled. This study website requires JavaScript.
    </noscript> 
    {% csrf_token %}

    <!-- display a list of comments to be reviewed -->
    <div x-data="{ atBottom: false }" class="grow w-full flex flex-col gap-y-2 mb-5 px-4">   
        <div class="grow-0 header flex flex-col gap-y-2 items-stretch bg-slate-100 p-4 rounded">
                {% if stage == "build" %}
                    <p class="text-2xl font-semibold">Set Your Filter's Goal</p>
                    <p class="text-lg text-start font-sans">
                       Before building your filter, please take a moment to label these comments as <span class="text-emerald-600 font-medium">Keep</span> or <span class="text-red-600 font-medium ">Remove</span>.
                       <br/>Your labels will be the gold standards for your filter to match. 
                       We'll use your labeled examples to assess how effectively your filter works. 
                    </p>
                {% elif stage == "update" %}
                    <p class="text-2xl font-semibold">Update Your Word Filters!</p>
                    <p class="text-lg text-start font-sans">
                        The world of social media is always changing, and so are the types of comments you see. <br/>
                        Before you update your word filter to these new trends, we need your help in labeling a fresh set of comments <br/>
                        Please label this new set of comments, which reflect recent trends. Your labels will help us evaluate the effectiveness of your updated filter 
                    </p>
                {% endif %}
        </div>
        <div class="grow flex mx-4 items-stretch">
            <div class="w-[70%] flex flex-col gap-y-2 items-start">

                <div id="countDisplay" class="grow-0 text-base italic text-blue-600"></div>

                <!-- display a list of comments to be reviewed -->
                <div id="textList"
                    @scroll="atBottom = $el.scrollHeight - $el.scrollTop - $el.clientHeight < 1"
                    class="grow flex flex-col px-4 border border-gray-600 rounded h-16 overflow-y-auto"
                ></div>
            </div>
            <div x-show="atBottom" class="w-[30%] flex flex-col justify-end gap-y-2 items-center px-4 pt-4">
                <!-- 
                <div class="grow-0 text-2xl font-medium">
                        How your old filter performed
                </div>  
                <div class="grow flex flex-col self-stretch gap-y-4">
                    
                    <div class="flex flex-col items-start">
                        <div class="text-slate-600 text-xl ">
                            <span class="text-xl font-bold">1</span>. Your filter's decisions match <br/>
                            <span class="text-2xl text-blue-500" id="test-accuracy">?</span> of your labels.
                        </div>
                    </div>
                   
                    <div class="flex flex-col items-start">
                        <div class="text-slate-600 text-xl ">
                            <span class="text-xl font-bold">2</span>. Your filter's removal decisions match <br/>
                                <span class="text-2xl text-blue-500" id="test-precision">?</span> of your removals.
                        </div>
                    </div>
                    
                    <div class="flex flex-col items-start">
                        <div class="text-slate-600 text-xl ">
                            <span class="text-xl font-bold">3</span>. Your filter correctly removes <br/>
                            <span class="text-2xl text-blue-500" id="test-recall">?</span> of comments you want to remove.
                        </div>
                    </div>
                    
                    <div class="flex flex-col items-start"> 
                        <div class="text-slate-600 text-xl">
                            <span class="text-xl font-bold">4</span>. Your filter falsely removes <br/>
                            <span class="text-2xl text-blue-500" id="test-fpr">?</span> of comments that you want to keep
                        </div>
                    </div>
                </div>
                 -->
                <div class="flex flex-col  bg-slate-100 rounded p-3">
                    <!--  -->
                    <p class="text-lg">
                            Thanks for your efforts in labeling these examples. Now start creating your filters!
                    </p>
                    <button 
                        class="text-white text-xl self-end bg-blue-600 px-4 py-1 rounded-lg"
                        @click="go_to_system();"
                    >GO</button>
                    <!-- 
                        <p class="text-lg">
                            Wanna see how your old filter adapts to these new comments?
                        </p>
                        <button 
                            class="text-white text-xl self-end bg-blue-600 px-4 py-1 rounded-lg"   
                            @click="test_filter();"
                        >Test</button>
                     -->
                </div>
            </div>
        </div>
    </div>
</body> <!-- closes container -->
<!-- custom js -->
<script src="{% static 'js/sharedsteps.js' %}" defer></script>
<script defer>
    const PARTICIPANT_ID = "{{participant_id}}";
    const STAGE = "{{stage}}";

    var old_performance = null;
    var logs = [];
    var dataset = [];
    var positive_number = 0;
    var label_number = 0;

    function change_label(index, new_label){
        let message = "";
        if(dataset[index].label == null){
            message = `[GroundTruth: LabelExamples] Labeled this text as ${new_label ? "positive" : "negative"}: "${dataset[index].text}"`;
        } else {
            message = `[GroundTruth: LabelExamples] Changed the label of the text to ${new_label ? "positive" : "negative"}: "${dataset[index].text}"`;
        }
        logs.push({
            time: new Date().toISOString(),
            message: message
        })
        // change the label of the text at the given index
        label_number = label_number + (dataset[index].label == null ? 1 : 0);

        dataset[index].label = new_label;
        // change the button color
        if(dataset[index].label){
            $(`#datum-${index} .yes-button`).removeClass('unselected-button').addClass('selected-button');
            $(`#datum-${index} .no-button`).removeClass('selected-button').addClass('unselected-button');
        } else {
            $(`#datum-${index} .no-button`).removeClass('unselected-button').addClass('selected-button');
            $(`#datum-${index} .yes-button`).removeClass('selected-button').addClass('unselected-button');

        }

        // update the number of positive examples
        positive_number = positive_number + (dataset[index].label ? 1 : 0);
        $('#positive-number').text(positive_number);
        $('#label-number').text(label_number);

    }

    function complete_label(callback_function){
        if(label_number < dataset.length){
                alert("Please label all the examples before proceeding");
                return;
            }

        logs.push({
            time: new Date().toISOString(),
            message: `[GroundTruth: Complete] Finished labeling groundtruth examples with ${positive_number} positive examples out of ${label_number} labeled examples.`,
        })

        post_backend(
                "/store_groundtruth/", {'dataset': dataset, 'participant_id': PARTICIPANT_ID, 'stage': STAGE, 'logs': logs},
                function(response) {
                    // if the json response has the response code 200
                    console.log(response);
                    if (!response['status']) {
                        alert(response['message']);
                        return;
                    }
                    callback_function();
                }
            );
    }
    
    function show_results(test_results, old_performance){
        let performance = test_results.performance;
        // show texts like build_performance.acuracy --> update_performance.accuracy
        $('#test-accuracy').html(`${to_percentage(old_performance.accuracy)}<i class="fa-solid fa-arrow-right text-gray-400 fa-sm px-4"></i>${to_percentage(performance.accuracy)}`);
        $('#test-precision').html(`${to_percentage(old_performance.precision)}<i class="fa-solid fa-arrow-right text-gray-400 fa-sm px-4"></i>${to_percentage(performance.precision)}`);
        $('#test-recall').html(`${to_percentage(old_performance.recall)}<i class="fa-solid fa-arrow-right text-gray-400 fa-sm px-4"></i>${to_percentage(performance.recall)}`);
        $('#test-fpr').html(`${to_percentage(old_performance.fpr)}<i class="fa-solid fa-arrow-right text-gray-400 fa-sm px-4"></i>${to_percentage(performance.fpr)}`);
    }

    function test_filter(){
        complete_label(
            function(){
                post_backend(
                    "/test_filter/", 
                    {'dataset': dataset, 'participant_id': PARTICIPANT_ID, 'stage': STAGE},
                    function(response) {
                        // if the json response has the response code 200
                        console.log(response);
                        if (!response['status']) {
                            alert(response['message']);
                            return;
                        }
                        old_performance = response.data.old_performance;
                        if("test_results" in response.data){
                            show_results(response.data.test_results, old_performance);
                        }
                        
                    }
                );
            }
        );    
    }

    function go_to_system(){
        if(STAGE === "build"){
            complete_label(
                function(){
                    redirect("/load_system/", {'participant_id': PARTICIPANT_ID, 'stage': STAGE});
                }
            );
        } else if(STAGE === "update"){
            complete_label(
                function(){
                    redirect("/load_system/", {'participant_id': PARTICIPANT_ID, 'stage': STAGE});
                }
            );
        }
        
    }

    $(document).ready(function(){
        dataset = display_labeling_data(JSON.parse(`{{dataset | safe}}`), dataset, false);
        
        // for testing purposes, use the score to simulate the user's label
        dataset.forEach((datum, index) => {
            if(index >= 0){
                change_label(index, +parseFloat(datum.score) >= 0.5);
            }
        })
    });

    


</script>
</html>