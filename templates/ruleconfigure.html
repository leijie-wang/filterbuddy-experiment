{% load static %}

<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Rule Configurer</title>
    <!-- use bootstrap UI -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
    <link href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="{% static 'css/sharedsteps.css' %}" />
    
    <script src="{% static 'js/jquery-3.7.1.js'%}"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://kit.fontawesome.com/95a71e9646.js" crossorigin="anonymous"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.3/dist/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.polyfills.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.1/Sortable.min.js" integrity="sha512-3N7dD+tlndNxwAC0PwGNWnnEpzHQwgNl6/c9XW6+nqptoMhbI9Rb6kQiUFtYmXrox60oIELVSFAO0dCSfKb2tw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-sortablejs@latest/jquery-sortable.js"></script>
    
</head>

<body class="container-none h-screen w-screen px-8">

    <!-- 
        The <noscript> tag encloses the content that will be displayed 
        only if JavaScript is disabled or not supported in the user's browser. 
    -->
    <noscript>
        If you see this text, your browser does not support dynamic content
        (JavaScript) or it has been disabled. This study website requires JavaScript.
    </noscript>
    {% csrf_token %}

    <div x-data="{}" class="flex flex-col justify-start gap-y-4 py-3 items-stretch h-full">
        <div class="flex-grow-0 flex gap-x-2 items-stretch">
            
            <div class="flex items-center justify-start bg-slate-100 p-3 rounded-md">
                <div class="text-xl text-black">
                    Do you know you can teach a filter to think like you? 
                    By labeling examples as <span class="text-emerald-600 font-medium">Keep</span> or <span class="text-red-600 font-medium ">Remove</span>, 
                    you're essentially teaching the filter to understand your standards.
                    In the next, please take up to <span class="font-medium">15 minutes</span> to label the provided examples as accurately as possible, based on what you feel fits your criteria.
                </div>
            </div>
            <div class="flex flex-col items-center justify-center">
                <div id="timer" class="flex items-center justify-center grow-0 text-2xl font-bold p-2 rounded-full border border-gray-500 aspect-square min-w-24">
                    15:00
                </div>
                <div class="text-base italic whitespace-nowrap">
                    minutes left
                </div>
            </div>
        </div>

        <div x-data="{stage: '{{ stage }}'}" class="flex items-stretch w-full gap-x-4 flex-grow">
            <!-- the section where users configure prompts -->
            <div class="flex flex-col items-stretch gap-y-4 rounded w-1/2 flex-grow">
                
                <!-- the section where users see all rules -->
                <div class="section-body flex flex-col flex-grow gap-y-4 pb-4">
                    <div class="flex flex-col gap-y-2 flex-grow h-1 pr-2 overflow-y-auto">
                        <div id="ruleList" class="flex flex-col gap-y-2">
 
                        </div>
                        <div @click="addNewRule" class="addButton flex justify-center items-center gap-x-4 border border-gray-300 rounded-lg h-10 cursor-pointer">
                            <div class="text-3xl text-gray-500">+</div>
                        </div>
                     </div>
                    <div class="bottom flex justify-end gap-x-2 flex-grow-0">
                        <button x-on:click="trainTrees();" class="bg-emerald-500 text-white font-bold py-2 px-3 rounded border ">
                            Apply Active Rules
                        </button>
    
                    </div>
                </div>
            </div>
            <!-- the section where users see example examples and predictions -->
            <div class="flex flex-col w-1/2 h-full">
                <!-- display a set of filter options -->
                
                <div class="flex flex-col gap-y-1 h-full border border-gray-600 rounded px-3 pt-2 pb-4 ">
                    <div class="header text-lg font-bold">
                        What comments are removed by your active rules?
                    </div>
                    <div class="self-stretch flex justify-between items-center gap-x-1">
                        <div id="countDisplay" class="grow text-sm text-gray-700 italic"></div>
                        <div class="grow flex justify-start items-center gap-x-2 ">
                            <!-- <div class="text-sm text-gray-600 ">View Options</div> -->
                            
                            
                            <select id="predictionFilter" class="selectpicker  data-filter border rounded show-tick" title="by predictions" data-width="100%" >
                                <option value="removed" class=" text-xs text-gray-700">Removed comments</option>
                                <option value="approved" selected class=" text-xs text-gray-700">Approved comments</option>
                                <option value="all" selected class=" text-xs text-gray-700">All comments</option>
                            </select>
                           
                            <!-- <div class="w-[45%]">
                                <select id="ruleFilter" multiple
                                    class="selectpicker data-filter show-tick border rounded" 
                                    title="by rules" 
                                    data-width="100%"
                                    data-selected-text-format="count"
                                    data-count-selected-text="{0} rules selected"
                                >
                                    
                                </select>
                            </div> -->
                        </div>
                        
                    </div>
                    <!-- display a list of comments to be reviewed -->
                    <div id="textList" class="body flex flex-col overflow-y-auto py-2 h-1 pr-2 flex-grow"></div>
                    <div class="bottom flex justify-end gap-x-2 pt-3">
                        <button @click="load_more_data" class="bg-slate-400 text-white font-bold py-2 px-3 rounded">
                            Load More Examples
                        </button>
                        <button @click="complete();" class="bg-blue-600  text-white font-bold py-2 px-3 rounded">
                            Create your Filter
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="loadingModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
            <div class="relative top-1/3 mx-auto p-5 border w-fit shadow-lg rounded-md bg-white">
                <div id="loadingModalText" class="text-center text-xl">
                    Loading...
                </div>
            </div>
        </div>

    </div>
</body> <!-- closes container -->
<!-- custom js -->
<script src="{% static 'js/sharedsteps.js' %}" defer></script>
<script defer>
    const COMPLETE_DATASET = JSON.parse(`{{dataset | safe}}`);
    const BATCH_SIZE = 30;
    const SYSTEM = "{{system}}";
    const PARTICIPANT_ID = "{{participant_id}}";
    const STAGE = "{{stage}}";
    

    var dataset = [];
    var current_batch = 0; 
    // we assume every single quote is properly escaped; this should be ensured when adding them to the list
    // for now, we only require users to input one example for each category
    var rules = {};
    var rule_counter = 0; // indicate the higher id that has been used

    var selected_rules = [];
    var selected_prediction = "all";

    var interval_id = null;
    var is_paused = false;
    var time_left = null;

    /* 
        functions that display, add, and remove rules
    */
    
    
    function updatePriority(){
        
        $('#ruleList .ruleSection').each(function(index) {
            // get the id of the ruleSection
            let id = +$(this).attr('id').split('-')[1];
            rules[id].priority = index;

            // update the priority class div of the this ruleSection
            // $(this).find('.priority').text(`${index + 1}.`);
        });
    }

    function updateOptions(id, text){
        // update the options of the select picker
        rules[id].name = text;
        // $(`#ruleFilter option[value=${id}]`).text(capitalize(text));
        // $(".selectpicker").selectpicker('refresh');
    }

    function getUnitSection(type, words, second_include=false){
        return `
            <div class='unitSection ${type}UnitSection flex flex-col gap-y-2 items-start pl-4 pr-4'>
                <div class='unitType ${type} w-fit relative text-start rounded ${type === "include" ? "bg-red-50" : "bg-emerald-50"} text-lg  py-1 px-3 italic'>
                    <span class="font-bold ">
                        ${
                            type === "exclude" ? 
                                '<i class="fa-solid fa-check fa text-emerald-600 mr-1"></i>' : 
                                '<i class="fa-solid fa-sm fa-magnifying-glass text-red-400 mr-1"></i>'
                            }
                    </span>
                    <span class="font-bold unitTitle">
                        ${
                            type === "exclude" ? "Unless including" : second_include ? "And include" : "If they include"
                        }
                    </span>
                    <span class="font-base">one of the following words</span>
                    <button class='absolute top-0 right-0 transform translate-x-1/2 -translate-y-1/2 bg-white rounded-full text-xs w-4 h-4 flex items-center justify-center border border-gray-300'
                        x-on:click="${type === "include" ? "includes = includes - 1; " : "excludes = excludes - 1; "}; removeUnitSection($event);"
                    >
                        &times;
                    </button>
                    
                </div>
                <div class='pl-6 self-stretch grow flex wordSection'>
                    <input 
                        class='grow wordList border-b-2 border-t-0 border-l-0 border-r-0 mb-2'
                        value='${words.join(",")}' 
                        autofocus
                    >
                </div>
            </div>`;
    }
    
    function removeUnitSection(event){
        let unit_sections = $(event.target).closest('.unitSections');
        $(event.target).closest(`.unitSection`).remove();
        unit_sections.find(".includeUnitSection").first().find('.unitTitle').text("If they include");
    }
    
    function addNewUnit(element, type){
        let unit_sections = $(element).closest('.ruleSection').find('.unitSections');
        // see how many unit sections are there
        let number_include = unit_sections.find('.includeUnitSection').length;
        let has_exclude = unit_sections.find('.excludeUnitSection').length > 0;
        if(type === "exclude" && has_exclude) { 
            return;
        } else if(type === "include" && number_include >= 2){
            return;
        }
        
        let unit_section_html = getUnitSection(type, [], number_include === 1);
        if(!has_exclude){
            unit_sections.append(unit_section_html);
            new Tagify(
                unit_sections.children().last().find('.wordList')[0], 
                {
                    placeholder: "Add another word, separated by comma",
                }
            );
        } else {
            unit_sections.children().last().before(unit_section_html);
            new Tagify(
                unit_sections.children().eq(-2).find('.wordList')[0],
                {
                    placeholder: "Add another word, separated by comma",
                }
            );
        }
        // tagify the newly added unit section
        
    }

    function displayRules(new_rules){
        // display the rules in the ruleList
        let ruleList = $('#ruleList');
        
        
        new_rules.forEach((rule) => {
            let open = ruleList.children().length === 0 ? "true" : "false";
            rule.id = rule_counter++;
            // the priority is the existing number of ruleSection items in the ruleList div
            rule.priority = ruleList.children().length;
            let unit_section_html = "";
            /*
                rule-section: where users select the corresponding action
                    unit-sections: where users configure include or exclude units
                        word-section: where users configure the word and its variants
            */
            second_include = false;
            rule.units.forEach((unit) => {
                unit_section_html  += getUnitSection(unit.type, unit.words, second_include);
                if(unit.type === "include") second_include = true;
            });

            let rule_div_html = `
                <div 
                    x-data="{
                        open: ${open}, 
                        active: true,
                        action: ${rule.action}, 
                        includes: ${rule.units.filter(unit => unit.type === "include").length}, 
                        excludes: ${rule.units.filter(unit => unit.type === "exclude").length},
                    }" 
                    class="ruleSection flex items-start gap-x-2"
                    :class="{ 'activeRuleSection': active, 'bg-gray-100': !active}" 
                    id="rule-${rule.id}"
                >   

                    <div class="grow flex flex-col items-stretch border !border-gray-300 rounded-lg px-2">
                        <div class="flex justify-between py-2">
                            <div class="grow text-black flex items-center font-serif gap-x-2">
                                <!-- <div class="priority text-2xl">
                                    ${rule.priority + 1}.
                                </div> -->
                                <!-- Toggle Switch for Rule Action -->
                                <div class="min-w-[20%] flex items-center font-medium text-xl ">
                                    <button 
                                        class="removeButton grow py-2 px-4 rounded italic" 
                                        :class="{ 'active bg-red-100': action === 1 && active, 'bg-gray-100 text-gray-300': action !== 1 || !active}" 
                                        x-on:click="action = 1"
                                    >
                                        Remove 
                                    </button>
                                    <!-- <button 
                                            class="approveButton grow py-2 px-4 rounded italic " 
                                            :class="{ 'active bg-emerald-100': action === 0, 'bg-gray-100 text-gray-300': action !== 0 }" 
                                            x-on:click="action = 0"
                                        >
                                            Keep
                                    </button> -->
                                    <span></span>
                                </div>
                                <div x-data="{charLimit: 30, inputExceedsLimit: false,  text: '${rule.name}' }" class="grow editableSectionTitle">
                                    <div 
                                        contenteditable="true" 
                                        x-text="text"
                                        x-on:input="text = $event.target.innerText; inputExceedsLimit = (text.length > charLimit); if(inputExceedsLimit) text = text.substr(0, charLimit); updateOptions(${rule.id}, text);"
                                        class="ruleName italic font-xl border border-gray-300 p-2 rounded"
                                        :class="{'border-red-500': inputExceedsLimit, 'text-gray-300': !active}"
                                        data-placeholder="What Texts?"
                                    ></div>
                                    
                                    <div x-show="inputExceedsLimit" 
                                        class="text-red-600 text-sm mt-1" 
                                        x-text="'The title should be less than ' + charLimit + ' characters.'"
                                    ></div>
                                </div>
                                
                            </div>
                            <!--have a foldable button-->
                            <div class="flex justify-center gap-x-2 ml-2">
                                <!-- <div class="flex items-center sortHandle focus:outline-none">
                                    <i class="fa-solid fa-up-down-left-right"></i>
                                </div> -->
                                <button @click="active = !active; open=false;" class="focus:outline-none">
                                    <i :class="active ? 'fa-solid fa-lg fa-toggle-off' : 'fa-solid fa-lg fa-toggle-on'"></i>
                                </button>
                                <button @click="deleteRule(${rule.id})" class="focus:outline-none">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                                <button 
                                    @click="open = !open" 
                                    class="focus:outline-none" 
                                    :class="{'text-gray-100': !active}" 
                                    :disabled="!active" 
                                >
                                    <svg x-show="!open" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                    <svg x-show="open" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div 
                            class="unitSections flex flex-col gap-y-4 py-2" x-show="open"
                        >
                            ${unit_section_html}
                        </div>
                        <div class="self-stretch flex justify-between gap-x-2 py-2 items-center" x-show="open">
                            <div class="">
                                <button 
                                    class="addInclude px-2 py-1 text-sm rounded"
                                    :class="{'bg-red-50': includes < 2, 'bg-gray-50 text-gray-400 cursor-not-allowed': includes >= 2}" 
                                    x-on:click="includes = includes + 1; addNewUnit($el, 'include')"
                                    :disabled="includes >= 2"
                                >
                                    <i class="fa-solid fa-magnifying-glass"  :class="{'text-red-400': includes < 2, 'text-gray-400': includes >= 2}"></i>
                                    Add Include
                                </button>
                                <button 
                                    class="addExclude px-2 py-1 text-sm rounded" 
                                    :class="{'bg-emerald-50': excludes < 1, 'bg-gray-50 text-gray-400 cursor-not-allowed': excludes >= 1}" 
                                    x-on:click="excludes = excludes + 1; addNewUnit($el, 'exclude')"
                                    :disabled="excludes >= 1"
                                >
                                    <i class="fa-solid fa-check" :class="{'text-emerald-600': excludes < 1, 'text-gray-400': excludes >= 1}"></i>
                                    Add Exceptions
                                </button>
                            </div>
                            <div class="flex p-1 gap-x-1 items-center">
                                <input type="checkbox" class="variantsCheckbox h-3 w-3" ${rule.variants ? "checked" : ""}/>
                                <label class="text-sm text-gray-600 font-medium">Detect spelling variants</label>
                                
                                <div x-data="{ open: false}">
                                    <!-- Tooltip Trigger -->
                                    <button 
                                        @click="open = !open" 
                                        class="p-1 rounded-full text-gray-700 hover:bg-gray-100"
                                    >
                                        <i class="fas fa-circle-question"></i>
                                    </button>

                                    <!-- Tooltip Content -->
                                    <div x-show="open" @click.away="open = false" 
                                        class="fixed z-50 w-fit p-2 text-sm text-white bg-gray-600 rounded-md shadow-lg" 
                                        
                                    >
                                        We only use the most common ways of spelling variants:
                                        <ul class="list-disc list-inside">
                                            <li>repeating letters (cool -> coool)</li>
                                            <li>mixed upper and lower case (cool -> cOoL)</li>
                                            <li>using similar looking characters (cool -> c00l)</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
            `;
        
            $('#ruleList').append(rule_div_html);
            rules[rule.id] = rule;

            // add an option to the select picker for this prompt, rules are not selected by default
            $('#ruleFilter').append(`<option value=${rule.id} class="text-xs">${rule.name.length === 0 ? "Unnamed Rule" : rule.name}</option>`);
            $(".selectpicker").selectpicker('refresh');
            
            // selected_rules.push(rule.id);

            $(`#rule-${rule.id} input.wordList`).each(function() {
                // Initialize Tagify on each input element
                let tag = new Tagify($(this)[0], {
                    placeholder: "Add another word, separate by comma",
                });
            });
        });
    }

    function deleteRule(deleted_id) {
        console.log(`deleting rule ${deleted_id}`);
        delete rules[deleted_id];
        $(`#rule-${deleted_id}`).remove();

        // remove the option from the select picker
        $(`#ruleFilter option[value=${deleted_id}]`).remove();
        $(".selectpicker").selectpicker('refresh');

        // remove the rule from selected_prompts if needed
        selected_rules = selected_rules.filter((id) => id != deleted_id);

        updatePriority();
    }

    function addNewRule(){
        // read from configuring rule panel and add this new rule to the rules in jquery
        let new_rule = {
                "action": 1,
                "name": [],
                "units": [{
                    "type": "include",
                    "words": [],
                }]   
            };
        displayRules([new_rule]);
    }

    /* 
        functions that handle the display of the data 
    */
    function load_more_data(new_separator=true){
        // load more data from the server
        /* get_backend(
            "/load_more_data/", 
            {'participant_id': participant_id},
            function(data){
                data = JSON.parse(data);
                dataset = display_data(data, dataset);
            }
        );*/

        let start = current_batch * BATCH_SIZE;
        let end = (current_batch + 1) * BATCH_SIZE;
        if(end >= COMPLETE_DATASET.length) end = COMPLETE_DATASET.length;
        let new_data = COMPLETE_DATASET.slice(start, end);
        dataset = display_data(new_data, dataset, new_separator);
        current_batch++;
    }

    function showFilteredData(){
        /* iterature through dataset and hide the datum that doesn't match the filter selected_prediction and selected_prompts */

        let expected_prediction = selected_prediction === "removed" ? [1] : selected_prediction === "approved" ? [0, null] : [1, 0, null];
        let counter = 0;
        let targeted_counter = 0;
        let approved_counter = 0;
        let removed_counter = 0;

        console.log("selected rules", selected_rules);
        console.log("selected_predictions", selected_prediction)
        dataset.forEach((datum, index) => {
            let show = expected_prediction.includes(datum.total_prediction);
            let now_prediction = null;
            /*  if(expected_prediction.length < 3){
                
                // otherwise, regardless of what rules are selected, we all show all comments as the expectd prediction is the all
                if (selected_rules.length > 0){
                    // only show comments that are targeted (not targeted) by all the selected rules
                    show = selected_rules.every(rule_id => {
                        let found_pred = datum.predictions.find(rule => rule.id === rule_id);
                        return found_pred !== undefined && expected_prediction.includes(found_pred.prediction);
                    })
                } else {
                    // show all comments that are targeted (not targeted) by any of the rules
                    show = expected_prediction.includes(datum.total_prediction);
                }
            } */

            
            if (show){
                $(`#datum-${index}`).parent().show();
            } else{
                $(`#datum-${index}`).parent().hide();
            }

            counter++;
            targeted_counter += datum.total_prediction !== null ? 1 : 0;
            approved_counter += datum.total_prediction === 0 ? 1 : 0;
            removed_counter += datum.total_prediction === 1 ? 1 : 0;
        });

        let text = `Your filter will remove ${removed_counter} out of ${dataset.length} comments in total.`;
        /* if(expected_prediction.length === 3) 
            text = `There are ${targeted_counter}/${counter} targeted comments in total; among them, ${approved_counter} approved and ${removed_counter} removed`;
        else if(selected_rules.length === 0 && selected_prediction === "targeted"){
            text = `There are ${counter} ${selected_prediction} comments in total; among them, ${approved_counter} approved and ${removed_counter} removed`;
        } else if(selected_rules.length === 0 && selected_prediction === "not-targeted"){
            text = `There are ${counter} ${selected_prediction} comments, so they are approvedy by default`;
        } else {
            text = `
                There are ${counter} comments that are ${selected_prediction} by all selected rules, ${approved_counter} approved and ${removed_counter} removed`;
        } */

        $('#countDisplay').text(text);

    }

    $("#predictionFilter").on("change", function() {
        selected_prediction = $(this).val();
        showFilteredData();
        
    });

    /* $("#ruleFilter").on("change", function() {
        selected_rules = [$(this).val()].map((value) => +value )
        showFilteredData();
    }); */
    
    function generateExplanation(datum, datum_index){
        /* generate the explanation for each prediction made by the LLMs */
        if (datum.total_prediction === null || datum.total_prediction === 0){
            $(`#datum-${datum_index}`).find('.datumText').html(datum.text);
            return "This comment will not be removed by any of your rules";
        }
        else {
            let explanation = `<p>This comment will be removed by the following rules :</p><ul class='list-none pl-0 text-gray-600'>`;
            // iterate through the dict object and format each prompt in a new line and with italic font

            let highest_priority_id = null;
            let highest_priority = 0;
            for (let i = 0; i < datum.predictions.length; i++) {
                const pred = datum.predictions[i];
                if (pred.prediction !== null){
                    let rule = rules[pred.id];
                    
                    explanation += `
                        <li class="before:content-['•'] before:mr-2">
                            Rule <span class="font-medium italic font-serif">${rule.name}</span>
                        </li>`;
                    if (highest_priority_id === null){
                        highest_priority = i;
                        highest_priority_id = pred.id;
                    }
                }
            }
            explanation += "</ul>";

            let highest_priority_rule = rules[highest_priority_id];
            explanation += `<br/><p>
                For the Rule <span class="font-bold italic font-serif">${highest_priority_rule.name}</span>, we highlight matched words in the comment.`;
            
            

            let replace_text = datum.text
            datum.predictions.find(pred => pred.id === highest_priority_id).patterns.forEach((pattern) => {
                let type = pattern[0];
                let word = pattern[1]
                replace_text = replace_text.replace(word, `<span class="font-bold text-lg italic">${word}</span>`);
            });
            
            $(`#datum-${datum_index}`).find('.datumText').html(replace_text);
            return explanation;
        }
    }

    function updateDataLabels(results) {
        /* update the labels of the data according to the predictions given by LLMs */
        let true_counter = 0;
        let prediction = results["prediction"];
        let texts_predictions = results["texts_predictions"];
    
        for (let i = 0; i < prediction.length; i++) {
            dataset[i].total_prediction = prediction[i];
            dataset[i].predictions = texts_predictions[i];
            
            // update the label according to the total prediction
            let new_class = dataset[i].total_prediction === null ? "unLabel" : dataset[i].total_prediction ? "trueLabel" : "falseLabel";
            const datum = $(`#datum-${i}`);
            datum.removeClass("unLabel trueLabel falseLabel");
            datum.addClass(new_class);

            // select the tooltip
            const tooltip_div = $(`#datumTooltip-${i}`);
            tooltip_div.removeClass("unLabel trueLabel falseLabel");
            tooltip_div.addClass(new_class);

            // update the tooltip content
            let explanation = generateExplanation(dataset[i], i);
            // set the second child of the tooltip div to be the explanation, use innerhtml

            tooltip_div.children().eq(1).html(explanation);
        }
    }

    /* 
        functions that handle the training of the tree classifier 
    */

    function parseContent() {
        /* we do not listen to the changes of the rules actively but instead parse the content when the user clicks the complete or classify button */
        // for each div element with the id format rules-${rule.rule_id}-${setting_index}, iterate over all children of the class termSection
        // for each termSection get the value of the synonyms via the class synonyms and the value of the checkbox via the class spellingVariants
        // update the corresponding rule's setting_index'th setting's value accordingly

        let now_rules = []
        $('#ruleList .ruleSection').each(function(index) {
            // parse out the id of the ruleSection
            let id = +$(this).attr('id').split('-')[1];
            let rule = rules[id];
            let active = $(this).hasClass('activeRuleSection');
            if(active){
                rule.name = $(this).find('.ruleName').text();
                rule.priority = index; // not used for now
                rule.action = $(this).find('.removeButton').hasClass('active') ? 1 : 0; // we consider removing a text as 1 and approving a text as 0
                rule.variants = $(this).find('.variantsCheckbox').is(':checked');
                
                let units = [];
                $(this).find('.unitSection').each(function() {
                    let unit = {};
                    unit.type = $(this).find('.unitType').hasClass('include') ? "include" : "exclude";
                    unit.words = [];
                    // iterature through the tags element with the class wordList and get the title of each children tag element
                    $(this).find('.tagify__tag').each(function() {
                        unit.words.push($(this).attr('title'));
                    });

                    if (unit.words.length > 0){
                        units.push(unit);
                    }
                });
                rule.units = units;
                if(rule.units.length > 0){
                    now_rules.push(rule);
                }
            }
        });
        console.log("parsed out rules: ", now_rules);
        return now_rules;
    }

    function trainTrees() {
        let now_rules = parseContent();
        $('#loadingModal').removeClass('hidden');
        $('#loadingModalText').text('Waiting for algorithms');
        is_paused = true;
        post_backend(
            "/trainTrees/", 
            {'dataset': dataset, 'rules': now_rules},
            function(response){
                if(!response["status"]){
                    alert(response["message"]);
                    return;
                }
                
                console.log(response.data.results);
                updateDataLabels(response.data.results);
                showFilteredData();
                
                $('#loadingModal').addClass('hidden');
                is_paused = false;
            }
        );
    }

    function complete(){
        is_paused = true;
        /* store the prompts written by the user */
        let now_rules = parseContent();
        post_backend(
            "/store_rules/", 
            {'rules': now_rules, 'participant_id': PARTICIPANT_ID, 'stage': STAGE},
            function(response){
                $('#loadingModal').removeClass('hidden');
                $('#loadingModalText').text('We are evaluating the performance of your filters, please wait for a moment.');
                if(!response["status"]){
                    alert(response["message"]);
                    $('#loadingModal').addClass('hidden');
                } else {
                    redirect("/validate_page/", {'participant_id': PARTICIPANT_ID, 'system': SYSTEM, 'stage': STAGE});
                }
            }
        )

    }

    function set_timer(){
        if (!is_paused) {
            time_left = time_left - 1000;

            // Time calculations for minutes and seconds
            var minutes = Math.floor((time_left % (1000 * 60 * 60)) / (1000 * 60));
            var seconds = Math.floor((time_left % (1000 * 60)) / 1000);

            // Output the result in the element with id="timer"
            $("#timer").text(minutes + ":" + (seconds < 10 ? "0" : "") + seconds);

            // If the countdown is over, stop the timer
            if (time_left < 0) {
                clearInterval(interval_id);
                $("#timer").text("00:00");
            }
        }
    }

    $(document).ready(function(){
        load_more_data(false);
        // $("#ruleList").sortable({
        //     animation: 150,
        //     handle: ".sortHandle",
        //     filter: ".addButton",
        //     onEnd: function(event, ui) {
        //         // console.log("updating priority");
        //         updatePriority();
        //     }
        // });

        if(STAGE === "update"){
            displayRules(JSON.parse(`{{rules | safe}}`));
        } else {
            displayRules([
                {
                    "action": 1,
                    "name": "Trump-related discussion",
                    "variants": true,
                    "units": [
                        {
                            "type": "include",
                            "words": ["Trump", "Donald Trump"],
                        },
                        {
                            "type": "exclude",
                            "words": ["trumpet", "trump card"],
                        }
                    ]
                },
                // {
                //     "action": 1,
                //     "name": "Sexual accusation",
                //     "variants": false,
                //     "units": [
                //         {
                //             "type": "include",
                //             "words": ["sex offender", "rapists", "fuck"],
                //         },
                //     ]   
                // },
                {
                    "action": 1,
                    "name": "Personal attack",
                    "variants": false,
                    "units": [
                        {
                            "type": "include",
                            "words": ["nonsense", "asshole", "stupid", "idiot", "fool", "stupidity"],
                        },

                    ]
                },
                // {
                //     "action": 0,
                //     "name": "Constructive Economy Discussion",
                //     "variants": true,
                //     "units": [
                //         {
                //             "type": "include",
                //             "words": ["progressive", "equity", "investing", "renewable", "growth", "sustainability", "balanced", "benefit", "protecting"]
                //         },
                //         {
                //             "type": "exclude",
                //             "words": ["ignorant", "stupid", "waste", "thieves", "stealing"]
                //         }

                //     ]
                // },
                {
                    "action": 1,
                    "name": "Terrorist accusation",
                    "variants": true,
                    "units": [
                        {
                            "type": "include",
                            "words": ["terrorists", "terrorist", "kill", "killing"]
                        },
                    ]

                }
            ]);
        }

        $("#timer").text("15:00");
        time_left = 15 * 60 * 1000;;
        interval_id = setInterval(set_timer, 1000);
    })
  
</script>
</html>