{% load static %}

<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Rule Configurer</title>
    <!-- use bootstrap UI -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
    <link href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="{% static 'css/sharedsteps.css' %}" />
    
    <script src="{% static 'js/jquery-3.7.1.js'%}"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://kit.fontawesome.com/95a71e9646.js" crossorigin="anonymous"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.3/dist/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.polyfills.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.1/Sortable.min.js" integrity="sha512-3N7dD+tlndNxwAC0PwGNWnnEpzHQwgNl6/c9XW6+nqptoMhbI9Rb6kQiUFtYmXrox60oIELVSFAO0dCSfKb2tw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-sortablejs@latest/jquery-sortable.js"></script>
    <script src="{% static 'js/utils.js' %}"></script>
    <script src="{% static 'js/base.js' %}"></script>
    <script src="{% static 'js/instruct.js' %}"></script>
    
    
</head>

<body class="container-none h-screen w-screen px-8">

    <!-- 
        The <noscript> tag encloses the content that will be displayed 
        only if JavaScript is disabled or not supported in the user's browser. 
    -->
    <noscript>
        If you see this text, your browser does not support dynamic content
        (JavaScript) or it has been disabled. This study website requires JavaScript.
    </noscript>
    {% csrf_token %}

    <div x-data="{}" class="flex flex-col justify-start gap-y-4 py-3 items-stretch h-full">
        <div class="flex-grow-0 flex gap-x-2 items-stretch">
            
            <div class="flex items-center justify-start bg-slate-100 p-3 rounded-md">
                <div class="text-xl text-black">
                    Have you ever tried to set up a word filter on your social media to block content? 
                    You can try a more advanced word filter now! You can set up rules to remove comments that include certain words, with the flexibility to make exceptions.
                    In the next, please take up to <span class="font-medium">15 minutes</span> to draft these rules as clearly as possible.
                </div>
            </div>
            <div class="flex flex-col items-center justify-center">
                <div id="timer" class="flex items-center justify-center grow-0 text-2xl font-bold p-2 rounded-full border border-gray-500 aspect-square min-w-24">
                    15:00
                </div>
                <div class="text-base italic whitespace-nowrap">
                    minutes left
                </div>
            </div>
        </div>

        <div x-data="{stage: '{{ stage }}'}" class="flex items-stretch w-full gap-x-4 flex-grow">
            <!-- the section where users configure prompts -->
            <div class="flex flex-col items-stretch gap-y-4 rounded w-1/2 flex-grow">
                
                <!-- the section where users see all instructions -->
                <div class="section-body flex flex-col flex-grow gap-y-4 pb-4">
                    <div class="flex flex-col gap-y-2 flex-grow h-1 pr-2 overflow-y-auto">
                        <div id="instructionList" class="flex flex-col gap-y-2">
 
                        </div>
                        <div @click="addNewInstruction" class="addButton flex justify-center items-center gap-x-4 border border-gray-300 rounded-lg h-10 cursor-pointer">
                            <div class="text-3xl text-gray-500">+</div>
                        </div>
                     </div>
                    <div class="bottom flex justify-end gap-x-2 flex-grow-0">
                        <button x-on:click="trainTrees();" class="bg-emerald-500 text-white font-bold py-2 px-3 rounded border ">
                            Apply Active Rules
                        </button>
    
                    </div>
                </div>
            </div>
            <!-- the section where users see example examples and predictions -->
            <div class="flex flex-col w-1/2 h-full">
                <!-- display a set of filter options -->
                
                <div class="flex flex-col gap-y-1 h-full border border-gray-600 rounded px-3 pt-2 pb-4 ">
                    <div class="header text-lg font-bold">
                        What comments are removed by your active rules?
                    </div>
                    <div class="self-stretch flex justify-between items-center gap-x-1">
                        <div id="countDisplay" class="grow text-sm text-gray-700 italic"></div>
                        <div class="grow flex justify-start items-center gap-x-2 ">
                            <select id="predictionFilter" class="selectpicker  data-filter border rounded show-tick" title="by predictions" data-width="100%" >
                                <option value="removed" class=" text-xs text-gray-700">Removed comments</option>
                                <option value="approved" selected class=" text-xs text-gray-700">Approved comments</option>
                                <option value="all" selected class=" text-xs text-gray-700">All comments</option>
                            </select>
                        </div>
                        
                    </div>
                    <!-- display a list of comments to be reviewed -->
                    <div id="textList" class="body flex flex-col overflow-y-auto py-2 h-1 pr-2 flex-grow"></div>
                    <div class="bottom flex justify-end gap-x-2 pt-3">
                        <button @click="loadMoreData()" class="bg-slate-400 text-white font-bold py-2 px-3 rounded">
                            Load More Examples
                        </button>
                        <button @click="complete();" class="bg-blue-600  text-white font-bold py-2 px-3 rounded">
                            Create your Filter
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="loadingModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
            <div class="relative top-1/3 mx-auto p-5 border w-fit shadow-lg rounded-md bg-white">
                <div id="loadingModalText" class="text-start text-xl text-gray-600">
                    Loading...
                </div>
            </div>
        </div>
        <div id="alertModal"  class="hidden fixed inset-0 bg-slate-300 bg-opacity-50 overflow-y-auto h-full w-full">
            <div class="relative top-1/3 mx-auto py-8 px-4 border w-fit shadow-lg rounded-lg bg-white flex flex-col justify-between gap-y-8">
                <div id="alertModalText" class="grow text-start text-xl text-gray-600">
                    <!-- Your alert message here -->
                </div>
                <div class="self-end flex gap-x-4">
                    <button @click="hideAlertModal();" class="grow-0 text-white py-1 px-3 rounded bg-gray-400 hover:bg-gray-500 font-semibold text-lg">
                        Cancel
                    </button>
                    <button id="alertModalButton"
                        @click="nextAlertModal();" class="grow-0  text-white py-1 px-3 rounded bg-blue-400 hover:bg-blue-500 font-semibold text-lg">
                        Okay
                    </button>
                </div>
                
                
            </div>
        </div>
    </div>
</body> <!-- closes container -->
<!-- custom js -->
<script>

    PARTICIPANT_ID = "{{participant_id}}";
    STAGE = "{{stage}}";
    SYSTEM = "{{system}}";
    
    INSTRUCTION_NAME = "rule";
    COMPLETE_DATASET = JSON.parse(`{{dataset | safe}}`);
    
    TEST_INSTRUCTIONS = [
                {
                    "action": 1,
                    "name": "Personal attack",
                    "variants": false,
                    "units": [
                        {
                            "type": "include",
                            "words": ["nonsense", "asshole", "stupid", "idiot", "fool", "stupidity"],
                        },

                    ]
                },
                {
                    "action": 1,
                    "name": "Sexual accusation",
                    "variants": false,
                    "units": [
                        {
                            "type": "include",
                            "words": ["sex offender", "rapists", "fuck"],
                        },
                    ]   
                },
                {
                    "action": 1,
                    "name": "Terrorist accusation",
                    "variants": true,
                    "units": [
                        {
                            "type": "include",
                            "words": ["terrorists", "terrorist", "kill", "killing"]
                        },
                    ]

                }
            ]
    
    new_instruction_template = {
        "action": 1,
        "name": [],
        "units": [{
            "type": "include",
            "words": [],
        }]   
    };

    /* 
        functions that help the authoring of prompts
    */
    function initialize_tagify(element, instruction_id){
        let tagify = new Tagify(
                element,
                {
                    placeholder: "Add another word, separated by comma",
                }
            );
        $(element).data("tagify", tagify);
        tagify.on("add", function(e){
            logEvents("AddTagifyPhrase", {phrase: e.detail.data.value, instruction_id: instruction_id});
        });

        tagify.on("remove", function(e){
            logEvents("RemoveTagifyPhrase", {phrase: e.detail.data.value, instruction_id: instruction_id});
        })
    }

    async function getSimilarPhrases(element){
        let word_input = $(element).closest('.unitSection').find('.wordList');
        let words = [];
        $(word_input).find('.tagify__tag').each(
            function() {
                words.push($(this).attr('title'));
            }
        );
        
        if(words.length === 0){
            showAlertModal("Please add at least one word to get similar phrases.");
            return;
        }
                
        let response = await post_backend(
            "/get_similar_phrases/", 
            {'phrases': words}
        )
    
        if(!response["status"]){
            showAlertModal(response["message"]);
            return;
        }
        
        let similar_phrases = response.data.phrases;
        let tagify = $(word_input[1]).data("tagify"); // get the tagify instance of the second word input
        tagify.addTags(similar_phrases);

        $(word_input[0]).find("tag").slice(-3).each(function(){
            $(this).addClass('newTag');
            // Set a timeout to remove the class after 2 seconds (2000 milliseconds)
            setTimeout(() => {
                $(this).removeClass('newTag');
            }, 8000);
        })

        logEvents("SuggestSynonyms", {words: words.join(", ")});
    }

    /* functions that display, add, and remove instructions */
    
    function getUnitSection(type, words, second_include=false){
        return `
            <div class='unitSection ${type}UnitSection flex flex-col gap-y-2 items-stretch pl-4 pr-4'>
                <div class='flex gap-x-2 items-center justify-between'>
                    <div class='unitType ${type} w-fit relative text-start rounded ${type === "include" ? "bg-red-50" : "bg-emerald-50"} text-lg  py-1 px-3 italic'>
                        <span class="font-bold ">
                            ${
                                type === "exclude" ? 
                                    '<i class="fa-solid fa-check fa text-emerald-600 mr-1"></i>' : 
                                    '<i class="fa-solid fa-sm fa-magnifying-glass text-red-400 mr-1"></i>'
                                }
                        </span>
                        <span class="font-bold unitTitle">
                            ${
                                type === "exclude" ? "Unless they include" : second_include ? "And include" : "If they include"
                            }
                        </span>
                        <span class="font-base">one of the following phrases</span>
                        <button class='absolute top-0 right-0 transform translate-x-1/2 -translate-y-1/2 bg-white rounded-full text-xs w-4 h-4 flex items-center justify-center border border-gray-300'
                            x-on:click="${type === "include" ? "includes = includes - 1; " : "excludes = excludes - 1; "}; removeUnitSection($event);"
                        >
                            &times;
                        </button>
                    </div>
                    <button x-data="{loading: false}" class="text-sm bg-yellow-50 p-2 rounded-lg" @click="loading = true; await getSimilarPhrases($el); loading = false">
                        <div class="spinner-border text-orange-300 spinner-border-sm" role="status" x-show="loading">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <i class="fa-regular fa-lg fa-lightbulb text-orange-400" x-show="!loading"></i>
                        <span>Similar phrases</span>
                    </button>
                </div>
                <div class='pl-6 self-stretch grow flex wordSection'>
                    <input 
                        class='grow wordList border-b-2 border-t-0 border-l-0 border-r-0 mb-2'
                        value='${words.join(",")}' 
                        autofocus
                    >
                </div>
            </div>`;
    }
    
    function removeUnitSection(event){
        let unit_section = $(event.target).closest('.unitSection');
        let instruction_secton = $(unit_section).closest('.instructionSection');
        let type = $(unit_section).hasClass('includeUnitSection') ? "include" : "exclude";
        
        
        // if there are only one include unit and the user wants to remove it, we should not remove it
        if(type === "include" && $(instruction_secton).find('.includeUnitSection').length === 1){
            showAlertModal("There should at least be one include unit in this rule box");
            return;
        }

        let instruction_id = $(unit_section).closest('.instructionSection').attr('id');
        logEvents("RemoveUnit", {type: type, instruction_id: instruction_id});
        $(unit_section).remove();
        // update the title of the second include unit if there are two include units
        
        $(instruction_secton).find(".includeUnitSection").first().find('.unitTitle').text("If they include");
    }
    
    function addNewUnit(element, type){
        let instruction_id = $(element).closest('.instructionSection').attr('id');
        let unit_sections = $(element).closest('.instructionSection').find('.unitSections');
        // see how many unit sections are there
        let number_include = unit_sections.find('.includeUnitSection').length;
        let has_exclude = unit_sections.find('.excludeUnitSection').length > 0;
        if(type === "exclude" && has_exclude) { 
            return;
        } else if(type === "include" && number_include >= 2){
            return;
        }
        

        logEvents("AddNewUnit", {type: type, instruction_id: instruction_id});
        let unit_section_html = getUnitSection(type, [], number_include === 1);
        let input;
        if(!has_exclude){
            unit_sections.append(unit_section_html);
            input = unit_sections.children().last().find('.wordList')[0]
        } else {
            unit_sections.children().last().before(unit_section_html);
            input = unit_sections.children().eq(-2).find('.wordList')[0];
        }
        // tagify the newly added unit section
        initialize_tagify(input, instruction_id);
        
        
    }

    function displayInstructions(new_instructions){
        // display the instructions in the instructionList
        let instructionList = $('#instructionList');
        
        new_instructions.forEach((instruction) => {
            // only the first instruction is open by default
            let open = instructionList.children().length === 0 ? "true" : "false";
            // the priority is the existing number of instructionSection items in the instructionList div
            instruction.priority = instructionList.children().length;
            instruction.id = instruction_counter++;
            
            
            let unit_section_html = "";
            /*
                instruction-section: the instruction block
                    unit-sections: where users configure include or exclude units
                        word-section: where users configure the word and its variants

                For now, we assumes that there will be at most 2 include units and 1 exclude unit. 
                The second include unit should add additional "add" description to the unit title.
            */
            second_include = false; 
            instruction.units.forEach((unit) => {
                unit_section_html  += getUnitSection(unit.type, unit.words, second_include);
                if(unit.type === "include") second_include = true;
            });

            let instruction_div_html = `
                <div 
                    x-data="{
                        open: ${open}, 
                        active: true,
                        action: ${instruction.action}, 
                        includes: ${instruction.units.filter(unit => unit.type === "include").length}, 
                        excludes: ${instruction.units.filter(unit => unit.type === "exclude").length},
                    }" 
                    class="instructionSection flex flex-col items-stretch border !border-gray-300 rounded-lg px-2"
                    :class="{ 'activeSection': active, 'bg-gray-100': !active}" 
                    id="instruction-${instruction.id}"
                >   
                    <div class="flex justify-between py-2">
                        <div class="grow text-black flex items-center font-serif gap-x-2">
                            <!-- Toggle Switch for instruction Action -->
                            <div class="min-w-[20%] flex items-center font-medium text-xl ">
                                <button 
                                    class="removeButton grow py-2 px-4 rounded italic" 
                                    :class="{ 'active bg-red-100': action === 1 && active, 'bg-gray-100 text-gray-300': action !== 1 || !active}" 
                                    x-on:click="action = 1"
                                >
                                    Remove 
                                </button>
                                <!-- <button 
                                        class="approveButton grow py-2 px-4 rounded italic " 
                                        :class="{ 'active bg-emerald-100': action === 0, 'bg-gray-100 text-gray-300': action !== 0 }" 
                                        x-on:click="action = 0"
                                    >
                                        Keep
                                </button> -->
                            </div>
                            <!-- Name of this instruction block -->
                            <div x-data="{charLimit: 30, inputExceedsLimit: false,  text: '${instruction.name}' }" class="grow editableSectionTitle">
                                <div 
                                    contenteditable="true" 
                                    x-text="text"
                                    x-on:input="text = $event.target.innerText; inputExceedsLimit = (text.length > charLimit); if(inputExceedsLimit) text = text.substr(0, charLimit); updateName(${instruction.id}, text);"
                                    class="instructionName italic font-xl border border-gray-300 p-2 rounded"
                                    :class="{'border-red-500': inputExceedsLimit, 'text-gray-300': !active}"
                                    data-placeholder="What Texts?"
                                ></div>
                                
                                <div x-show="inputExceedsLimit" 
                                    class="text-red-600 text-sm mt-1" 
                                    x-text="'The title should be less than ' + charLimit + ' characters.'"
                                ></div>
                            </div>
                            
                        </div>
                        <div class="flex justify-center gap-x-2 ml-2">
                            <!-- <div class="flex items-center sortHandle focus:outline-none">
                                <i class="fa-solid fa-up-down-left-right"></i>
                            </div> -->
                            <!-- Toggle on or off this instruction -->
                            <button @click="active = !active; open=false; logEvents('ActivateInstruction', {active: active, instruction_id: ${instruction.id}})" class="focus:outline-none">
                                <i :class="active ? 'fa-solid fa-lg fa-toggle-off' : 'fa-solid fa-lg fa-toggle-on'"></i>
                            </button>
                            <!-- Delete this instruction -->
                            <button @click="deleteInstruction(${instruction.id})" class="focus:outline-none">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                            <!-- Fold or unfold this instruction -->
                            <button 
                                @click="open = !open" 
                                class="focus:outline-none" 
                                :class="{'text-gray-100': !active}" 
                                :disabled="!active" 
                            >
                                <svg x-show="!open" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                                <svg x-show="open" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div 
                        class="unitSections flex flex-col gap-y-4 py-2" x-show="open"
                    >
                        ${unit_section_html}
                    </div>
                    <div class="self-stretch flex justify-between gap-x-2 py-2 items-center" x-show="open">
                        <div class="">
                            <button 
                                class="addInclude px-2 py-1 text-sm rounded"
                                :class="{'bg-red-50': includes < 2, 'bg-gray-50 text-gray-400 cursor-not-allowed': includes >= 2}" 
                                x-on:click="includes = includes + 1; addNewUnit($el, 'include')"
                                :disabled="includes >= 2"
                            >
                                <i class="fa-solid fa-magnifying-glass"  :class="{'text-red-400': includes < 2, 'text-gray-400': includes >= 2}"></i>
                                Add Include
                            </button>
                            <button 
                                class="addExclude px-2 py-1 text-sm rounded" 
                                :class="{'bg-emerald-50': excludes < 1, 'bg-gray-50 text-gray-400 cursor-not-allowed': excludes >= 1}" 
                                x-on:click="excludes = excludes + 1; addNewUnit($el, 'exclude')"
                                :disabled="excludes >= 1"
                            >
                                <i class="fa-solid fa-check" :class="{'text-emerald-600': excludes < 1, 'text-gray-400': excludes >= 1}"></i>
                                Add Exceptions
                            </button>
                        </div>
                        <div x-data="{ checked: ${instruction.variants}, open: false}" class="flex p-1 gap-x-1 items-center">
                            <input type="checkbox" x-model="checked" class="variantsCheckbox h-3 w-3" @click="checked = !checked; logEvents('SpellingVariants', {checked: checked, instruction_id: ${instruction.id}})"/>
                            <label class="text-sm text-gray-600 font-medium">Detect spelling variants</label>
                            
                            <div>
                                <!-- Tooltip Trigger -->
                                <button 
                                    @click="open = !open" 
                                    class="p-1 rounded-full text-gray-700 hover:bg-gray-100"
                                >
                                    <i class="fas fa-circle-question"></i>
                                </button>

                                <!-- Tooltip Content -->
                                <div x-show="open" @click.away="open = false" 
                                    class="fixed z-50 w-fit p-2 text-sm text-white bg-gray-600 rounded-md shadow-lg" 
                                    
                                >
                                    We only use the most common ways of spelling variants:
                                    <ul class="list-disc list-inside">
                                        <li>repeating letters (cool -> coool)</li>
                                        <li>mixed upper and lower case (cool -> cOoL)</li>
                                        <li>using similar looking characters (cool -> c00l)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>   
                </div>
            `;
        
            $('#instructionList').append(instruction_div_html);
            instructions[instruction.id] = instruction;

            $(`#instruction-${instruction.id} input.wordList`).each(function() {
                // Initialize Tagify on each input element
                initialize_tagify($(this)[0], instruction.id);
            });
        });
    }

    /* functions that handle the training of the tree classifier */

    function parseContent() {
        /* we do not listen to the changes of the instructions actively but instead parse the content when the user clicks the complete or classify button */
        // for each div element with the id format instructions-${instruction.instruction_id}-${setting_index}, iterate over all children of the class termSection
        // for each termSection get the value of the synonyms via the class synonyms and the value of the checkbox via the class spellingVariants
        // update the corresponding instruction's setting_index'th setting's value accordingly

        let now_instructions = []
        $('#instructionList .instructionSection').each(function(index) {
            // parse out the id of the instructionSection
            let id = +$(this).attr('id').split('-')[1];
            let instruction = instructions[id];
            let active = $(this).hasClass('activeSection');
            if(active){
                instruction.name = $(this).find('.instructionName').text();
                instruction.priority = index; // not used for now
                instruction.action = $(this).find('.removeButton').hasClass('active') ? 1 : 0; // we consider removing a text as 1 and approving a text as 0
                instruction.variants = $(this).find('.variantsCheckbox').is(':checked');
                
                let units = [];
                $(this).find('.unitSection').each(function() {
                    let unit = {};
                    unit.type = $(this).find('.unitType').hasClass('include') ? "include" : "exclude";
                    unit.words = [];
                    // iterature through the tags element with the class wordList and get the title of each children tag element
                    $(this).find('.tagify__tag').each(function() {
                        unit.words.push($(this).attr('title'));
                    });

                    if (unit.words.length > 0){
                        units.push(unit);
                    }
                });
                instruction.units = units;
                if(instruction.units.length > 0){
                    now_instructions.push(instruction);
                }
            }
        });
        console.log("parsed out instructions: ", now_instructions);
        return now_instructions;
    }

    function trainTrees() {
        let now_instructions = parseContent();
        showLoadingModal("Waiting for the results")
        logEvents("TrainTrees", {instruction_len: now_instructions.length, dataset_len: dataset.length});
        
        post_backend(
            "/trainTrees/", 
            {'dataset': dataset, 'instructions': now_instructions},
            function(response){
                if(!response["status"]){
                    showAlertModal(response["message"]);
                    return;
                }
                
                console.log(response.data.results);
                updateDataLabels(response.data.results);
                showFilteredData();
                
                hideLoadingModal();
            }
        );
    }

    function save_system(time_spent){
        let now_instructions = parseContent();
        post_backend(
            "/store_rules/", 
            {'instructions': now_instructions, 'participant_id': PARTICIPANT_ID, 'stage': STAGE, "time_spent": time_spent},
            function(response) {
                if(!response["status"]){
                    console.warn(response["message"]);
                } else {
                    console.log(`Save the created rules successfully at ${time_spent / 1000} seconds.`);
                }
            }
        ); 
    }
    
    function complete(timeout=false, exit=false){
        /* store the labeled examples and then redirect to the validation page where an ML model will be trained */
        if(!exit && !timeout){
            showAlertModal("You still have time to author more rules. Are you sure that you want to create your filter now?", "Yes", () => complete(timeout, true));
            return;
        } 

        if(timeout){
            message = "This session ends. Thank you for your time. We are now evaluating how your filter performs, so please wait for a moment.";
        } else {
            message = "We are evaluating how your filter performs, so please wait for a moment.";
        }
        
       
        showLoadingModal(message);
        
        let now_instructions = parseContent();
        logEvents("Complete", {instruction_len: now_instructions.length, dataset_len: dataset.length});
        post_backend(
            "/store_rules/", 
            {'instructions': now_instructions, 'participant_id': PARTICIPANT_ID, 'stage': STAGE, "logs": logs, "time_spent": time_spent},
            function(response){
                if(!response["status"]){
                    hideLoadingModal();
                    showAlertModal(response["message"]);
                } else {
                    // the rule training is too fast, so we add a delay to show the loading modal
                    console.log("System: ", SYSTEM, "Stage: ", STAGE);
                    setTimeout(function(){
                        redirect("/validate_page/", {'participant_id': PARTICIPANT_ID, 'system': SYSTEM, 'stage': STAGE});
                    }, 3000);
                   
                }
            }
        )

    }

    $(document).ready(function(){ 
        if(DEBUG) {
            displayInstructions(TEST_INSTRUCTIONS);
        } else {
            console.log("loading instructions", JSON.parse(`{{instructions | safe}}`));
            displayInstructions(JSON.parse(`{{instructions | safe}}`));
        }
        
        time_spent = parseInt("{{time_spent}}");
        startTimer(SESSION_TIME);
        loadMoreData(false);
        logEvents("Start", {})

        if(Object.keys(instructions).length === 0){
            console.log("No instructions are loaded. We will add a new instruction for the user.");
            addNewInstruction();
        }
    })
  
    /* function updatePriority(){
        
        $('#instructionList .instructionSection').each(function(index) {
            // get the id of the instructionSection
            let id = +$(this).attr('id').split('-')[1];
            instructions[id].priority = index;

            // update the priority class div of the this instructionSection
            // $(this).find('.priority').text(`${index + 1}.`);
        });
    } */ 

    /* $("#instructionList").sortable({
            animation: 150,
            handle: ".sortHandle",
            filter: ".addButton",
            onEnd: function(event, ui) {
                // console.log("updating priority");
                updatePriority();
            }
        }); */


</script>
</html>