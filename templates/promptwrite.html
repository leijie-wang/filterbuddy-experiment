{% load static %}

<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Prompt Writer</title>
    <!-- use bootstrap UI -->
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
    <!-- base layout -->
    <link rel="stylesheet" href="{% static 'css/sharedsteps.css' %}" />
    
    <script src="{% static 'js/jquery-3.7.1.js' %}"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="{% static 'js/diff_match_patch_uncompressed.js' %}"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://kit.fontawesome.com/95a71e9646.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.3/dist/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.1/Sortable.min.js" integrity="sha512-3N7dD+tlndNxwAC0PwGNWnnEpzHQwgNl6/c9XW6+nqptoMhbI9Rb6kQiUFtYmXrox60oIELVSFAO0dCSfKb2tw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-sortablejs@latest/jquery-sortable.js"></script>
    <script src="{% static 'js/utils.js' %}"></script>
    <script src="{% static 'js/base.js' %}"></script>
    <script src="{% static 'js/instruct.js' %}"></script>
    
</head>

<body class="container-none h-screen w-screen px-8">

    <!-- 
      The <noscript> tag encloses the content that will be displayed 
      only if JavaScript is disabled or not supported in the user's browser. 
    -->
    <noscript>
        If you see this text, your browser does not support dynamic content
        (JavaScript) or it has been disabled. This study website requires JavaScript.
    </noscript> 
    {% csrf_token %}
    <div x-data="{}" class="flex flex-col justify-start gap-y-3 py-3 items-stretch h-full">
        <div class="flex-grow-0 flex gap-x-2 items-stretch">
            {% if tutorial %}
            <div class="grow flex items-center gap-x-8 bg-blue-50 p-3 rounded-md">
                <div class="grow-0 text-4xl font-bold text-sky-800 font-serif">
                    Tutorial
                </div>
                <div class="grow flex flex-col">
                    <div class="text-lg leading-8">
                        <p class="text-gray-600">
                            Just like chatting with ChatGPT, you can outline what comments to remove through clear prompts and examples.</br>
                            But remember it might take a few minutes to process your prompts, so please be patient!
                        </p>
                        <p class="font-medium">
                            In the next step, please spend <span class="text-blue-600">3 minutes</span> first 
                            reading 
                            <a 
                                href="https://docs.google.com/presentation/d/1sINDVJPCSkSTvng5PIIFz3S5AOBYpL4-vjkJhx4B3c4/edit#slide=id.p" 
                                class="text-blue-500 hover:text-blue-600 underline" target="_blank"
                            >the tutorial slides</a> 
                            and then exploring the interface.
                        </p>
                    </div>
                </div>
            </div>
            {% elif stage == "build" %}
            <div class="grow flex items-center gap-x-8 bg-green-50 p-3 rounded-md">
                <div class="grow-0 text-4xl font-bold text-emerald-800 font-serif">
                    Create
                </div>
                <div class="grow flex flex-col">
                    <div class="text-lg leading-8">
                        <p class="text-gray-600">
                            
                            Just like chatting with ChatGPT, you can outline what comments to remove through clear prompts and examples.</br>
                            But remember it might take a few minutes to process your prompts, so please be patient!
                        </p>
                        <p class="font-medium">
                            In the next, please take up to <span class="font-medium">15 minutes</span> to write your prompts, trying to be as clear and specific as possible.
                        </p>
                    </div>
                </div>
            </div>
            {% elif stage == "update" %}
            <div class="grow flex items-center gap-x-8 bg-yellow-50 p-3 rounded-md">
                <div class="grow-0 text-4xl font-bold text-orange-600 font-serif">
                    Update
                </div>
                <div class="grow flex flex-col">
                    <div class="text-lg leading-8">
                        <p class="text-gray-600">
                            Just like chatting with ChatGPT, you can outline what comments to remove through clear prompts and examples.</br>
                            But remember it might take a few minutes to process your prompts, so please be patient!
                        </p>
                        <p class="font-medium">
                            To keep up with the latest trends, please spend <span class="font-medium">15 minutes</span> improving your prompts, trying to be as clear and specific as possible.
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}
            <div class="flex flex-col items-center justify-center">
                <div id="timer" class="flex items-center justify-center grow-0 text-2xl font-bold p-2 rounded-full border-2 border-gray-500 aspect-square min-w-24">
                    15:00
                </div>
                <div class="text-base italic whitespace-nowrap">
                    minutes left
                </div>
            </div>
        </div>

        <div class="flex items-stretch w-full gap-x-4 flex-grow">
            <!-- the section where users configure instructions -->
            <div x-data="" class="flex flex-col items-stretch gap-y-4 px-2 w-1/2 flex-grow">
                <!-- <div class="section-header text-xl font-bold text-blue-600 flex-grow-0 self-center">
                Write Your Instructions
            </div> -->

                <!-- the section where users see all instructions -->
                <div class="section-body flex flex-col flex-grow gap-y-1 pb-2">
                    <!-- <div class="flex flex-col gap-y-2 flex-grow-0">
                        <div class="text-lg italic">
                            Instruction Introduction
                        </div>
                        <textarea rows="2" id="instructionOverview" class="bg-gray-100 border border-gray-300 rounded-lg p-2 text-base w-full" placeholder="Write an overview of your instruction"></textarea>
                    </div> -->
                    
                    <div class="flex flex-col gap-y-2 flex-grow h-1 overflow-y-auto">
                       <div id="instructionList" class="flex flex-col gap-y-2">

                       </div>
                       <div @click="addNewInstruction" class="addButton flex justify-center items-center gap-x-4 border-2 !border-gray-400 rounded-lg h-10 cursor-pointer">
                            <div class="text-3xl text-gray-500">+</div>
                        </div>
                    </div>
                   
                    <div class="bottom flex justify-end gap-x-2 flex-grow-0">
                        <button @click="trainLLM();" class="bg-blue-500 text-white font-bold py-2 px-3 rounded">
                            Apply Active Prompts
                        </button>
                    </div>
                </div>
                <!-- Add this h-1 to override a weird behavior of flex layout, 
                        see this stackoverflow answer for more details https://stackoverflow.com/q/75368940/9508684.
                        In short, the overflow proerty requries a fixed length on the container. 
                        Without a fixed length (height or width), there's nothing to trigger an overflow. 
                        The flex-grow property doesn't establish a fixed length, so it doesn't work.
                        So, to solve both problems, set the container to height: 1px. It will still grow to fill the available space.
                    -->
            </div>
            <!-- the section where users example examples and predictions -->
            <div class="flex flex-col w-1/2 h-full">
                <!-- display a set of filter options -->
                <div class="grow flex flex-col gap-y-1 h-full pb-2">
                    <div class="grow flex flex-col gap-y-1 border-2 !border-gray-400 rounded px-3 pt-2">
                        <div class="grow-0 header text-lg font-bold">
                            How Do Your Active Rules Perform?
                        </div>
                        <div class="grow-0 self-stretch flex justify-between items-center gap-x-1">
                            <div id="countDisplay" class="grow text-sm text-gray-700 italic"></div>
                            <div class="grow flex justify-start items-center gap-x-2 ">
                                <select id="predictionFilter" class="selectpicker  data-filter border rounded show-tick" title="by predictions" data-width="100%" >
                                    <option value="removed" class=" text-xs text-gray-700">Review Removed comments</option>
                                    <option value="approved" selected class=" text-xs text-gray-700">Review Approved comments</option>
                                    <option value="all" selected class=" text-xs text-gray-700">Review All comments</option>
                                </select>
                            </div>
                            
                        </div>
                        <!-- display a list of comments to be reviewed -->
                        <div class="grow body flex flex-col gap-y-2 overflow-y-auto h-1 pb-4">
                            <div id="textList" class="grow flex flex-col pt-2 mr-2 border-b-2 !border-gray-400 border-dashed"></div>
                            <button @click="loadMoreData()" class="grow-0 min-w-[50%] bg-slate-400 text-white font-bold py-2 px-3 rounded mx-auto">
                                Load More Examples
                            </button>
                        </div>
                        
                    </div>
                    <div class="bottom flex justify-end gap-x-2 pt-3">
                        
                        {% if tutorial %}
                            <button @click="complete()" class="bg-green-600 text-white font-bold py-2 px-3 rounded">
                                Finish the Tutorial
                            </button>
                        {% else %}
                            <button @click="complete()" class="bg-green-600 text-white font-bold py-2 px-3 rounded">
                                Create your Filter
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div id="loadingModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
            <div class="relative top-1/3 mx-auto p-5 border w-fit shadow-lg rounded-md bg-white">
                <div id="loadingModalText" class="text-start text-xl text-gray-600">
                    Loading...
                </div>
            </div>
        </div>
        <div id="alertModal"  class="hidden fixed inset-0 bg-slate-300 bg-opacity-50 overflow-y-auto h-full w-full">
            <div class="relative top-1/3 mx-auto py-8 px-4 border w-fit shadow-lg rounded-lg bg-white flex flex-col justify-between gap-y-8">
                <div id="alertModalText" class="grow text-start text-xl text-gray-600">
                    <!-- Your alert message here -->
                </div>
                <div class="self-end flex gap-x-4">
                    <button @click="hideAlertModal();" class="grow-0 text-white py-1 px-3 rounded bg-gray-400 hover:bg-gray-500 font-semibold text-lg">
                        Cancel
                    </button>
                    <button id="alertModalButton"
                        @click="nextAlertModal();" class="grow-0  text-white py-1 px-3 rounded bg-blue-400 hover:bg-blue-500 font-semibold text-lg">
                        Okay
                    </button>
                </div>
                
                
            </div>
        </div>
    </div>
</body>
<!-- closes container -->
<!-- custom js -->
<script>
    PARTICIPANT_ID = "{{participant_id}}";
    STAGE = "{{stage}}";
    SYSTEM = "{{system}}";
    TUTORIAL = "{{ tutorial }}" == "True";
    BATCH_SIZE = 10; // avoid participants to load a lot of data
    INSTRUCTION_NAME = "prompt";
    COMPLETE_DATASET = JSON.parse(`{{dataset | safe}}`);
    
    TEST_INSTRUCTIONS = [
                {
                    "name": "Racial hate speech",
                    "action": 1,
                    "rubric": "Catch all texts that promote hate, discrimination, stereotypes, or violence against individuals or groups based on their race, ethnicity, or national origin.",
                    "positives": ["You are just some mad browskin because Europeans styled on your ass"],
                    "negatives": ["83% of US blacks are Christians"],
                },
               
                {
                    "name": "Violence calls",
                    "action": 1,
                    "rubric": "Catch all texts that directly incite violence or call for harm against specific groups or individuals",
                    "positives": ["it pleases me to know you will die"],
                    "negatives": []

                },
                // {   
                //     "name": "Gender hate speech",
                //     "action": 1,
                //     "rubric": "Catch all texts that are derogatory, demeaning, or violent towards individuals based on their gender or gender identity",
                //     "positives": [],
                //     "negatives": ["What didnâ€™t the Bitch say. I hate talking to people in the morning"]
                // }
            ]
    
    new_instruction_template = {
            "name": "",
            "action": 1,
            "rubric": "",
            "positives": [],
            "negatives": []
        };
    /*
        functions that help the authoring of instructions
    */

    function getCleanPhrases(instruction_input, accept=true){
        if(accept){
            $(instruction_input).find(".deletion").remove();
            $(instruction_input).find(".insertion").each(function(){
                let text = $(this).text();
                $(this).replaceWith(text);
            });
            $(instruction_input).find("button").remove();
        } else {
            $(instruction_input).find(".insertion").remove();
            $(instruction_input).find(".deletion").each(function(){
                let text = $(this).text();
                $(this).replaceWith(text);
            });
            $(instruction_input).find("button").remove();
        }
    }
    
    function acceptNewPhrases(element){
        logEvents("AcceptNewPhrases", {instruction_id: $(element).closest('.instructionSection').attr('id')});
        let instruction_input = $(element).closest('.instructionRubric');
        getCleanPhrases(instruction_input, true);
        
    }

    function rejectNewPhrases(element){
        logEvents("RejectNewPhrases", {instruction_id: $(element).closest('.instructionSection').attr('id')});
        let instruction_input = $(element).closest('.instructionRubric');
        getCleanPhrases(instruction_input, false);
        
    }

    async function getRephraseInstruction(element){
        let instruction_id = $(element).closest('.instructionSection').attr('id');
        let instruction_input = $(element).closest('.instructionSection').find('.instructionRubric');
        let instruction = instruction_input.text().trim();
        
        
        let response = await post_backend(
            "/get_rephrase_instruction/", 
            {'instruction': instruction}
        )
    
        if(!response["status"]){
            alert(response["message"]);
            return;
        }
        let rephrase_instruction = response.data.instruction;
        logEvents("RephraseInstruction", {instruction: instruction, rephrase_instruction: rephrase_instruction, instruction_id: instruction_id})
        
        // update the instruction input with the rephrase instruction
       
        let diffs = diff_wordMode(instruction, rephrase_instruction);
        
       
        let diff_html = "";
        diffs.forEach(diff => {
            let op = diff[0];
            let text = diff[1];
            if(op === 1) {
                // insertion
                diff_html += `<span class="insertion mx-0 text-orange-500">${text}</span>`;
            } else if(op === -1) {
                // deletion
                diff_html += `<span class="deletion mx-0 text-slate-500 line-through">${text}</span>`;
            } else {
                diff_html += `<span class="mx-0">${text}</span>`;
            }
        });
        diff_html += `
                <button @click='enabled = true; acceptNewPhrases($el)' 
                    class='ml-1 p-1 bg-orange-100 rounded font-serif font-bold shadow-sm'
                > Accept </button>
                <button @click='enabled = true; rejectNewPhrases($el)' 
                    class='ml-1 p-1 bg-slate-100 rounded font-serif font-bold shadow-sm'
                > Reject </button>
                `
        instruction_input.html(diff_html);
    }

    function displayInstructions(new_instructions) {
       
        let instructionList = $('#instructionList');

        new_instructions.forEach((instruction) => {
            // only the first instruction is open by default
            let open = instructionList.children().length === 0 ? "true" : "false";
            // the priority is the existing number of instructionSection items in the instructionList div
            instruction.priority = instructionList.children().length;
            instruction.id = instruction_counter++;
            
            let instruction_div_html = `
                <div 
                    x-data="{
                        open: ${open},
                        active: true, 
                        action: ${instruction.action}
                    }" 
                    class="instructionSection flex flex-col items-stretch border-2 !border-gray-400 rounded-lg px-2" 
                    :class="{ 'activeSection': active, 'bg-gray-100': !active}" 
                    id="instruction-${instruction.id}"
                >
                    <div class="flex justify-between py-2">
                        <div class="grow text-black flex items-center font-serif gap-x-2">
                            <!-- <div class="priority text-2xl">
                                ${instruction.priority + 1}.
                            </div> -->
                            <!-- Toggle Switch for Rule Action -->
                            <div class="min-w-[20%] flex items-center font-medium text-xl">
                                <button 
                                    class="removeButton grow py-2 px-4 rounded italic" 
                                    :class="{ 'active bg-red-100': action === 1, 'bg-gray-100 text-gray-300': action !== 1}" 
                                    x-on:click="action = 1"
                                >
                                    Remove
                                </button>
                                <!-- <button 
                                    class="approveButton grow py-2 px-4 rounded italic " 
                                    :class="{ 'active bg-emerald-100': action === 0, 'bg-gray-100 text-gray-300': action !== 0 }" 
                                    x-on:click="action = 0"
                                >
                                    Keep
                                </button> -->
                            </div>
                            <div x-data="{charLimit: 30, inputExceedsLimit: false,  text: '${instruction.name}' }" class="grow editableSectionTitle">
                                <div 
                                    contenteditable="true" 
                                    x-text="text"
                                    x-on:input="text = $event.target.innerText; inputExceedsLimit = (text.length > charLimit); if(inputExceedsLimit) text = text.substr(0, charLimit); updateName(${instruction.id}, text);"
                                    class="instructionName italic font-xl border border-gray-300 p-2 rounded"
                                    :class="{'border-red-500': inputExceedsLimit, 'text-gray-300': !active}"
                                    data-placeholder="What Texts?"
                                ></div>
                                <div x-show="inputExceedsLimit" 
                                    class="text-red-600 text-sm mt-1" 
                                    x-text="'The title should be less than ' + charLimit + ' characters.'"
                                ></div>
                            </div>
                        </div>
                        <!--have a foldable button-->
                        <div class="flex justify-center gap-x-2 ml-2">
                            <!-- <div class="flex items-center sortHandle focus:outline-none">
                                <i class="fa-solid fa-up-down-left-right"></i>
                            </div> -->
                            <button @click="active = !active; open=false; logEvents('ActivateInstruction', {active: active, instruction_id: ${instruction.id}});" class="focus:outline-none">
                                <i :class="active ? 'fa-solid fa-lg fa-toggle-on' : 'fa-solid fa-lg fa-toggle-off'"></i>
                            </button>
                            <button @click="deleteInstruction(${instruction.id})" class="focus:outline-none">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                            <button 
                                @click="open = !open" 
                                class="focus:outline-none"                                 
                                :class="{'text-gray-100': !active}" 
                                :disabled="!active"
                            >
                                <svg x-show="!open" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                                <svg x-show="open" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="flex flex-col gap-y-2 items-stretch p-4 pt-2" x-show="open">
                        <div x-data="{loading: false, enabled: true}" class="flex flex-col items-stretch gap-y-2">
                            <div class="flex justify-between">
                                <div class="w-fit text-lg italic bg-red-50 py-1 px-3 rounded">
                                    <span><i class="fa-solid fa-pencil mr-1"></i></span>
                                    <span>Describe the texts </span>
                                    <span class="font-bold">you want to remove</span>
                                </div>
                                <button :disabled="!enabled"  
                                    class="text-sm p-2 rounded-lg"
                                    :class="{'cursor-not-allowed bg-gray-50': !enabled, 'bg-yellow-50': enabled}"
                                    @click="loading = true; markChanged(${instruction.id}); await getRephraseInstruction($el); enabled = false; loading = false"
                                >
                                    <div class="spinner-border text-orange-300 spinner-border-sm" role="status" x-show="loading">
                                        <span class="sr-only">Loading...</span>
                                    </div>
                                    <i class="fa-regular fa-lg fa-lightbulb" 
                                        :class="{'text-gray-400': !enabled, 'text-orange-400': enabled}"
                                        x-show="!loading"></i>
                                    <span>Improve</span>
                                </button>
                            </div>
                            <div class="self-stretch grow flex pl-6 pr-4">
                                <div 
                                    contenteditable="true" 
                                    class="instructionRubric grow text-base text-gray-700 border-b-2 border-t-0 border-l-0 border-r-0 mb-2 px-2 py-1"
                                    @input="markChanged(${instruction.id})"
                                >
                                    ${instruction.rubric}
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col gap-y-2">
                            <div class="w-fit text-lg italic bg-red-50 py-1 px-3 rounded">
                                <span><i class="fa-solid fa-sm fa-magnifying-glass text-red-400 mr-1"></i></span>
                                <span>Provide an example that should be </span>
                                <span class="font-bold">removed</span>
                                
                            </div>
                            <div class="self-stretch grow flex pl-6 pr-4">
                                <div 
                                    contenteditable="true" 
                                    class="instructionPositiveExample example grow text-sm text-gray-700 border-b-2 border-t-0 border-l-0 border-r-0 mb-2 px-2 py-1"
                                    @input="markChanged(${instruction.id})"
                                >
                                    ${instruction.positives.length > 0 ? instruction.positives[0] : ""}
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col gap-y-2">
                            <div class="w-fit text-lg italic bg-emerald-50 py-1 px-3 rounded">
                                <span><i class="fa-solid fa-check fa text-emerald-600 mr-1"></i></span>
                                <span>Provide an example that should </span>
                                <span class="font-bold">not be removed</span>
                            </div>
                            <div class="self-stretch grow flex pl-6 pr-4">
                                <div 
                                    contenteditable="true" 
                                    class="instructionNegativeExample example grow text-sm text-gray-700 border-b-2 border-t-0 border-l-0 border-r-0 mb-2 px-2 py-1"
                                    @input="markChanged(${instruction.id})"
                                >
                                    ${instruction.negatives.length > 0 ? instruction.negatives[0] : ""}
                                </div>
                            </div>
                        </div>
                       

                    </div>
                </div>`;
            $('#instructionList').append(instruction_div_html);
            instruction["changed"] = true;
            instructions[instruction.id] = instruction;            
        });
    }

    function parseContent() {
        /* we do not listen to the changes of the instructions actively but instead parse the content when the user clicks the complete or classify button */
        now_instructions = [];
        $("#instructionList .instructionSection").each(function(index){
            let id = +$(this).attr('id').split('-')[1];
            let instruction = instructions[id];
            let active = $(this).hasClass('activeSection');
            if(active){
                // the name is always updated
                instruction.name = escape_single_quote($(this).find('.instructionName').text());
                instruction.priority = index;
                instruction.action =  $(this).find('.removeButton').hasClass('active') ? 1 : 0; // we consider removing a text as 1 and approving a text as 0
                getCleanPhrases($(this).find('.instructionRubric'), true); // accept by default
                instruction.rubric = escape_single_quote($(this).find('.instructionRubric').text(), remove_newline=true);
                
                let positive_example = $(this).find('.instructionPositiveExample').text();
                if(positive_example) instruction.positives[0] = escape_single_quote(positive_example, remove_newline=true);

                let negative_example = $(this).find('.instructionNegativeExample').text();
                if(negative_example) instruction.negatives[0] = escape_single_quote(negative_example, remove_newline=true);

                if(instruction.rubric.length > 0) now_instructions.push(instruction);
            }
            

        });
        console.log("parsed out instructions", now_instructions);
        return now_instructions;

    }

    function markChanged(id){
        instructions[id].changed = true;
    }

    function trainLLM() {
        let now_instructions = parseContent();
        
        let changed_length = Object.values(instructions).filter(instruction => instruction.changed).length;
        let unchanged_length = Object.values(instructions).length - changed_length;
        let new_data_length = dataset.filter(datum => datum.predictions === null).length;

        // add a countdown timer to the loading modal
        let estimated_time = Math.ceil(40 / 120 * (changed_length * dataset.length + unchanged_length * new_data_length + 20));
        showLoadingModal(`We are evaluating the performance of your filters. <br/> It is estimated to take <b>${estimated_time}</b> seconds, please wait for a moment.`);

        let countdown_timer = setInterval(function(){
            showLoadingModal(`We are evaluating the performance of your filters. <br/> It is estimated to take <b>${estimated_time}</b> seconds, please wait for a moment.`)

            if (estimated_time <= 0) {
                clearInterval(countdown_timer);
                showLoadingModal(`The evaluation is taking longer than expected, and thanks for your patience.`);
            }
            estimated_time--; 
        }, 1000);

        post_backend(
            "/trainLLM/", 
            {'dataset': dataset, 'instructions': now_instructions},
            function(response){
                if(!response["status"]){
                    alert(response["message"]);
                    return;
                }
                let task_id = response.data.task_id;
                logEvents("TrainLLM", {instruction_len: now_instructions.length, dataset_len: dataset.length, task_id: task_id})
                pollForResults(task_id, countdown_timer);

            }
        );
    }

    function pollForResults(task_id, countdown_timer=null) {
        const pollInterval = 2000; // Poll every 2 seconds
        
        var poll = setInterval(function() {
            $.ajax({
                url: "/get_LLM_results/" + task_id + "/", 
                type: "GET",
                success: function(response) {
                    if (response["status"]) {
                        console.log("predictions", response.data.results);
                        Object.values(instructions).forEach(instruction => {
                            instruction.changed = false;
                        });
                        console.log("predictions", response.data.results);
                        updateDataLabels(response.data.results);
                        showFilteredData();
                        hideLoadingModal();
                        clearInterval(countdown_timer);
                        clearInterval(poll); // Stop polling since task is complete
                        logEvents("LLMResults", {task_id: task_id})
                    } else {
                        console.log("Task is still processing...");
                    }
                },
                error: function() {
                    showAlertModal("Error polling for task results.");
                    clearInterval(poll); // Stop polling on error
                }
            });
        }, pollInterval);
    }

    function save_system(time_spent){
        let now_instructions = parseContent();
        post_backend(
            "/store_prompts/", 
            {'instructions': now_instructions, 'participant_id': PARTICIPANT_ID, 'stage': STAGE, "time_spent": time_spent},
            function(response) {
                if(!response["status"]){
                    console.warn(response["message"]);
                } else {
                    console.log(`Save the created prompts successfully at ${time_spent / 1000} seconds.`);
                }
            }
        ); 
    }

    function complete(timeout=false, exit=false){
        if(TUTORIAL){
            if(!exit && !timeout){
                showAlertModal("You still have time for your tutorial. Are you sure that you want to skip the tutorial?", "Yes", () => complete(timeout, true));
                return;
            } 
            redirect("/load_system/", {'participant_id': PARTICIPANT_ID});
            return;
        }

        /* store the labeled examples and then redirect to the validation page where an ML model will be trained */
        if(!exit && !timeout){
            showAlertModal("You still have time to write more prompts. Are you sure that you want to create your filter now?", "Yes", () => complete(timeout, true));
            return;
        } 

        let now_instructions = parseContent();
        if(Object.keys(now_instructions).length === 0){
            console.log("No instructions to save");
            showAlertModal("Please write at least one prompt.");
            return;
        }

        if(timeout){
            message = "This session ends. Thank you for your time. We are now evaluating how your filter performs, so please wait for a moment.";
        } else {
            message = "We are evaluating how your filter performs, so please wait for a moment.";
        }

        showLoadingModal(message);
        
        logEvents("Complete", {instruction_len: now_instructions.length, dataset_len: dataset.length});
        post_backend(
            "/store_prompts/", 
            {'instructions': now_instructions, 'participant_id': PARTICIPANT_ID, 'stage': STAGE, 'logs': logs, "time_spent": time_spent},
            function(response){
                if(!response["status"]){
                    hideLoadingModal();
                    showAlertModal(response["message"]);
                } else {
                    redirect("/validate_page/", {'participant_id': PARTICIPANT_ID, 'system': SYSTEM, 'stage': STAGE});
                }
                    
            }
        )
    }

    $(document).ready(function(){
        $(".copyButton").tooltip();
        
        if(DEBUG || TUTORIAL) {
            displayInstructions(TEST_INSTRUCTIONS);
        } else {
            displayInstructions(JSON.parse(`{{instructions | safe}}`));
        }

        time_spent = parseInt("{{time_spent}}");
        if(TUTORIAL){
            startTimer(TUTORIAL_TIME)
        } else {
            startTimer(SESSION_TIME);
        }

        
        loadMoreData(false);
        logEvents("Start", {})

        if(Object.keys(instructions).length === 0){
            addNewInstruction();
        }
    })
    

    
</script>
</html>