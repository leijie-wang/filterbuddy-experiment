{% load static %}

<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>System Validation</title>
  <!-- use bootstrap UI -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <!-- base layout -->
  <link rel="stylesheet" href="{% static 'css/sharedsteps.css' %}" />
  <script src="https://kit.fontawesome.com/95a71e9646.js" crossorigin="anonymous"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="{% static 'js/jquery-3.7.1.js'%}"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>

<body class="h-screen w-screen overflow-y-hidden flex flex-col">

    <!-- 
      The <noscript> tag encloses the content that will be displayed 
      only if JavaScript is disabled or not supported in the user's browser. 
    -->
    <noscript>
        If you see this text, your browser does not support dynamic content
        (JavaScript) or it has been disabled. This study website requires JavaScript.
    </noscript> 
    {% csrf_token %}

    <div x-data="{}" class="grow w-full flex flex-col gap-y-4 mb-10 px-4">
        <!-- display a list of comments to be reviewed -->
        <div class="grow-0 header flex flex-col gap-y-2 items-stretch bg-slate-100 p-4 rounded">
            {% if stage == "build" %}
                <p class="text-2xl font-semibold">Curious about how your filter performs?</p>
                <p class="text-lg text-start font-sans">
                    Thank you for your hard work in creating your unique filter! Remember those examples you labeled earlier? It's time to see how your filter did.
                   <br> We've compared your initial labels with the predictions made by your filter. Below, you'll find a detailed performance report. 
                </p>
            {% elif stage == "update" %}
                <p class="text-2xl font-semibold">Discover How Your Updated Filter Performs!</p>
                <p class="text-lg text-start font-sans">
                    Thanks for updating your filter! Recall those new examples you labeled earlier? 
                    Now it's time to see the results. <br/>
                    We've compared your labels with the predictions made by your updated filter. 
                    Below, you'll find how well your filter is adapting to the latest trends in social media. Let's explore its performance together!
                </p>
            {% endif %}

            
        </div>
        <div class="grow flex flex-row mx-4 items-stretch">
            <div class="flex flex-col gap-y-2 w-2/3">
                <div class="grow-0 flex justify-start">
                    <div id="countDisplay" class="text-base text-blue-600"></div>
                </div>
                <!-- display a list of comments to be reviewed -->
                <div id="textList"
                    class="grow flex flex-col h-16 overflow-y-auto px-4 border border-gray-600 rounded"
                ></div>
            </div>
            <!-- display the results of algorithmic predictions -->
            <div class="flex flex-col items-start gap-y-4 w-1/3">
                  
                <div class="grow flex flex-col mx-[10%] self-stretch justify-evenly gap-y-4">
                    <!-- Accuracy -->
                    <div class="flex flex-col items-center gap-y-2">
                        <div class="text-slate-600 text-lg text-center">How many comments are flagged correctly</div>
                        <div class="text-3xl text-blue-500" id="test-accuracy">?</div>
                    </div>
                    <!-- Precision -->
                    <div class="flex flex-col items-center gap-y-2">
                        <div class="text-slate-600 text-lg text-center">How many comments flagged as removed are truly toxic </div>
                        <div class="text-3xl text-blue-500" id="test-precision">?</div>
                    </div>
                    <!-- Recall -->
                    <div class="flex flex-col items-center gap-y-2">
                        <div class="text-slate-600 text-lg text-center">How many toxic comments are removed</div>
                        <div class="text-3xl text-blue-500" id="test-recall">?</div>
                    </div>
                    <!-- False Positive Rate -->
                    <div class="flex flex-col items-center gap-y-2"> 
                        <div class="text-slate-600 text-lg text-center">How many non-toxic comments are mistakenly flagged as removed</div>
                        <div class="text-3xl text-blue-500" id="test-fpr">?</div>
                    </div>
                </div>
                    
                {% if stage == "build" %}
                    <div class="grow-0 flex flex-col gap-y-4 bg-slate-100 rounded mx-[10%] p-3">
                        <p class="text-lg">
                            Thanks for your efforts in labeling these examples. Now start building your own filters
                        </p>
                        <button 
                            class="text-white text-lg self-end bg-blue-600 p-2 rounded-lg"
                            @click="go_to_system();"
                        >
                            Improve your filter
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</body> <!-- closes container -->
<!-- custom js -->
<script src="{% static 'js/sharedsteps.js' %}" defer></script>
<script defer>
    const PARTICIPANT_ID = "{{participant_id}}";
    const SYSTEM = "{{system}}";
    const STAGE = "{{stage}}";
    const TASK_ID = "{{task_id}}";

    var dataset = JSON.parse(`{{dataset | safe}}`);

    var positive_number = 0;
    function change_label(index, new_label){
        dataset[index].label = new_label;
        // change the button color
        if(dataset[index].label){
            $(`#datum-${index} .yes-button`).removeClass('unselected-button').addClass('selected-button');
            $(`#datum-${index} .no-button`).removeClass('selected-button').addClass('unselected-button');
        } else {
            $(`#datum-${index} .no-button`).removeClass('unselected-button').addClass('selected-button');
            $(`#datum-${index} .yes-button`).removeClass('selected-button').addClass('unselected-button');

        }

        // update the number of positive examples
        positive_number = positive_number + (dataset[index].label ? 1 : 0);
        $('#positive-number').text(positive_number);
    }

    function go_to_system(){
        redirect("/onboarding/", {'participant_id': PARTICIPANT_ID});
    }

    function show_results(results, build_performance){
        // enumerate all datum class div in the textList and append a div at the end of the datum div
        console.log("results", results);
        console.log("build_performance", build_performance);


        dataset.forEach((datum, index) => {
            // Generate the new div HTML you want to append
            // For demonstration, appending a simple div with a class 'extra-info'
            // You can customize this HTML as needed
            datum.total_prediction = results.prediction[index];
            datum.predictions = results.texts_predictions?.[index] || null;
            let new_div = `
                    <div class="flex-col items-stretch grow-0 font-bold w-[5%] text-center">
                        ${datum.label == datum.total_prediction ? 
                            "<span class='text-gray-900'><i class='fa-solid fa-check px-2 fa-xl'></i></span>" : 
                            "<span class='text-gray-900'><i class='fa-solid fa-xmark px-2 fa-xl'></i></span>"
                        }
                    </div>`;

            // Append the new div to the current datum div
            $(`#datum-${index}`).append(new_div);
        });
        
        let performance = results.performance;
        if(STAGE === "build"){
            $('#test-accuracy').text(to_percentage(performance.accuracy));
            $('#test-precision').text(to_percentage(performance.precision));
            $('#test-recall').text(to_percentage(performance.recall));
            $('#test-fpr').text(to_percentage(performance.fpr));
            $('#test-fnr').text(to_percentage(performance.fnr));
        } else if(STAGE === "update"){
            // show texts like build_performance.acuracy --> update_performance.accuracy
            $('#test-accuracy').html(`${to_percentage(build_performance.accuracy)}<i class="fa-solid fa-arrow-right text-gray-400 fa-sm px-4"></i>${to_percentage(performance.accuracy)}`);
            $('#test-precision').html(`${to_percentage(build_performance.precision)}<i class="fa-solid fa-arrow-right text-gray-400 fa-sm px-4"></i>${to_percentage(performance.precision)}`);
            $('#test-recall').html(`${to_percentage(build_performance.recall)}<i class="fa-solid fa-arrow-right text-gray-400 fa-sm px-4"></i>${to_percentage(performance.recall)}`);
            $('#test-fpr').html(`${to_percentage(build_performance.fpr)}<i class="fa-solid fa-arrow-right text-gray-400 fa-sm px-4"></i>${to_percentage(performance.fpr)}`);
        }
    }

    function pollForResults(task_id) {
        const pollInterval = 2000; // Poll every second
        
        var poll = setInterval(function() {
            console.log("Polling for task results...");
            $.ajax({
                url: "/get_validate_results/", 
                type: "GET",
                data: {"participant_id": PARTICIPANT_ID, "stage": STAGE, task_id: task_id},
                success: function(response) {
                    if (response["status"]) {
                        console.log(response.data.results);
                        show_results(response.data.test_results, response.data.build_performance);
                        
                        clearInterval(poll); // Stop polling since task is complete
                    } else {
                        console.log("Task is still processing...");
                    }
                },
                error: function() {
                    alert("Error polling for task results.");
                    clearInterval(poll); // Stop polling on error
                }
            });
        }, pollInterval);
    }

    $(document).ready(function(){
        
        let textList = $('#textList');
        // for testing purposes, use the score to simulate the user's label
        dataset.forEach((datum, index) => {
            let text_div_html = `
                <div id="datum-${index}" class="datum flex flex-row items-center space-x-1 py-1 border-b border-gray-300">   
                    <div id="text-${index}" class="grow w-[85%] p-2">${escape_html(datum.text)}</div>
                    <div class="flex-col items-stretch grow-0 w-[10%] text-center">
                        ${datum.label == 1 ? 
                            "<div class='w-full text-white bg-red-400 text-base p-1 rounded'>Remove</div>" : 
                            "<div class='w-full text-white bg-emerald-400 text-base p-1 rounded'>Approve</div>"
                        }
                    </div>
                </div>`;
            textList.append(text_div_html);
        });

        if(TASK_ID !== ""){

            pollForResults(TASK_ID);
        } else {
            let test_results = JSON.parse(`{{test_results | safe}}`);
            let build_performance = JSON.parse(`{{build_performance | safe}}`);
            show_results(test_results, build_performance);
        }     
    });

    


</script>
</html>