{% load static %}

<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Eval {{system}}</title>
  <!-- use bootstrap UI -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <!-- base layout -->
  <link rel="stylesheet" href="{% static 'css/sharedsteps.css' %}" />
  <script src="https://kit.fontawesome.com/95a71e9646.js" crossorigin="anonymous"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="{% static 'js/jquery-3.7.1.js'%}"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="{% static 'js/utils.js' %}"></script>
  <script src="{% static 'js/base.js' %}"></script>
</head>

<body class="h-screen w-screen overflow-y-hidden flex flex-col">

    <!-- 
      The <noscript> tag encloses the content that will be displayed 
      only if JavaScript is disabled or not supported in the user's browser. 
    -->
    <noscript>
        If you see this text, your browser does not support dynamic content
        (JavaScript) or it has been disabled. This study website requires JavaScript.
    </noscript> 
    {% csrf_token %}

    <div x-data="{}" class="grow w-full flex flex-col gap-y-0 mb-10">
        <!-- display a list of comments to be reviewed -->
        <div class="grow-0 header flex flex-col gap-y-2 items-stretch bg-slate-100 px-4 pt-4 pb-3 rounded">
            {% if stage == "build" %}
                <div class="grow flex items-center gap-x-8 bg-blue-50 p-3 rounded-md">
                    <div class="grow-0 text-4xl font-bold text-sky-800 font-serif">
                        Evaluate
                    </div>
                    <div class="grow flex flex-col">
                        <div class="text-lg leading-8">
                            <p class="text-gray-600">
                                Curious about how your filter performs?
                                Remember the examples you labeled in the first stage as gold standards? 
                                </br> We've analyzed how your filter's decisions match up against those labels.
                            </p>
                            <p class="font-medium">
                                In the next step, please review 1) how your filter's decisions match your labels, and 2) the overall performance of your filter.
                            </p>
                        </div>
                    </div>
                </div>
            {% elif stage == "update" %}
                <p class="text-2xl font-semibold">Discover How Your Updated Filter Performs!</p>
                <p class="text-lg text-start font-sans">
                    Thank you for your hard work in updating your filter! Remember the you labeled earlier as gold standards? 
                    We've analyzed how your filter's decisions match up against those labels.
                    Below, you'll find a breakdown: 
                    on the left, we indicate if the filter's prediction matches your label for each example, 
                    and on the right, we present the overall performance of your filter, compared to your old filter's performance on this new set of comments.
                </p>
            {% endif %}

            
        </div>
        <div class="grow flex flex-row mx-4 items-stretch">
            <div class="flex flex-col items-stretch gap-y-2 w-2/3">
                <div class="grow-0 flex justify-start">
                    <div id="countDisplay" class="text-base text-blue-600"></div>
                </div>
                <!-- display a list of comments to be reviewed --> 
                <div id="textList-header" class="min-w-[20%] datum flex justify-end gap-x-4 font-serif italic py-0.5 pr-3">   
                    <div class="font-bold">Your label</div>
                    <div class="font-bold">Filter decision</div>
                    
                </div>
                <div id="textList"
                    class="grow flex flex-col h-16 overflow-y-auto border-2 !border-gray-500 rounded"
                >
                    
                </div>
            </div>
            <!-- display the results of algorithmic predictions -->
            <div class="mt-6 flex flex-col items-start gap-y-2 w-1/3">
                <div class="grow-0 text-2xl font-medium mx-[10%]">
                    {% if stage == "build" %}
                        How your filter performs
                    {% elif stage == "update" %}
                        The performance change from your old filter to your updated filter 
                    {% endif %}
                </div>  
                <div class="grow flex flex-col mx-[10%] self-stretch justify-evenly gap-y-4">
                    <!-- Accuracy -->
                    <div class="flex flex-col items-start">
                        <div class="text-slate-600 text-xl ">
                            <span class="text-xl font-bold">1</span>. Your filter's decisions match <br/>
                            <span class="text-2xl text-blue-500" id="test-accuracy">?</span> of your labels.
                        </div>
                    </div>
                    <!-- Precision -->
                    <div class="flex flex-col items-start">
                        <div class="text-slate-600 text-xl ">
                            <span class="text-xl font-bold">2</span>. Your filter's removal decisions match <br/>
                                <span class="text-2xl text-blue-500" id="test-precision">?</span> of your removals.
                        </div>
                    </div>
                    <!-- Recall -->
                    <div class="flex flex-col items-start">
                        <div class="text-slate-600 text-xl ">
                            <span class="text-xl font-bold">3</span>. Your filter correctly removes <br/>
                            <span class="text-2xl text-blue-500" id="test-recall">?</span> of comments you want to remove.
                        </div>
                    </div>
                    <!-- False Positive Rate -->
                    <div class="flex flex-col items-start"> 
                        <div class="text-slate-600 text-xl">
                            <span class="text-xl font-bold">4</span>. Your filter falsely removes <br/>
                            <span class="text-2xl text-blue-500" id="test-fpr">?</span> of comments that you want to keep
                        </div>
                    </div>
                </div>
                    
                
                <div class="self-end grow-0 flex justify-end mx-[10%]">
                    <button 
                        class="text-white text-xl font-medium bg-blue-600 p-3 rounded-lg"
                        @click="go_to_system();"
                    >
                        Next
                    </button>
                </div>
                
            </div>
        </div>
        <div id="loadingModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
            <div class="relative top-1/3 mx-auto p-5 border w-fit shadow-lg rounded-md bg-white">
                <div id="loadingModalText" class="text-start text-xl text-gray-600">
                    Loading...
                </div>
            </div>
        </div>
        <div id="alertModal"  class="hidden fixed inset-0 bg-slate-300 bg-opacity-50 overflow-y-auto h-full w-full">
            <div class="relative top-1/3 mx-auto py-8 px-4 border w-fit shadow-lg rounded-lg bg-white flex flex-col justify-between gap-y-8">
                <div id="alertModalText" class="grow text-start text-xl text-gray-600">
                    <!-- Your alert message here -->
                </div>
                <button 
                    id="alertModalButton"
                    @click="hideAlertModal();" 
                    class="grow-0 self-end text-white py-1 px-3 rounded bg-blue-400 hover:bg-blue-500 font-semibold text-lg"
                >
                    Okay
                </button>
            </div>
        </div>
    </div>
</body> <!-- closes container -->
<!-- custom js -->

<script defer>
    PARTICIPANT_ID = "{{participant_id}}";
    SYSTEM = "{{system}}";
    STAGE = "{{stage}}";
    DEBUG = "{{debug}}" === "True"

    const TASK_ID = "{{task_id}}";

    dataset = JSON.parse(`{{dataset | safe}}`);

    function go_to_system(){
        console.log("go_to_system survey", SURVEY);
        if(SURVEY){
            // get the first example of false removal and false approve
            let false_removal_example = dataset.find(datum => datum.label == 0 && datum.total_prediction == 1)?.text || "";
            let false_approve_example = dataset.find(datum => datum.label == 1 && datum.total_prediction == 0)?.text || "";
            localStorage.setItem("examples", JSON.stringify({
                'false_remove': false_removal_example,
                'false_approve': false_approve_example
            }));
            redirect("/survey/", {
                    'participant_id': PARTICIPANT_ID, 'stage': STAGE, 'system': SYSTEM, 'debug': DEBUG
                }, true
            );
        } else {
            redirect("/onboarding/", {'participant_id': PARTICIPANT_ID, 'stage': STAGE, 'system': SYSTEM, 'debug': DEBUG}, true);
        }
    }

    function showResults(results, old_results=null){
        // enumerate all datum class div in the textList and append a div at the end of the datum div
        console.log("results", results);
        

        dataset.forEach((datum, index) => {
            // Generate the new div HTML you want to append
            // For demonstration, appending a simple div with a class 'extra-info'
            // You can customize this HTML as needed
            datum.total_prediction = results.prediction[index];
            datum.predictions = results.texts_predictions?.[index] || null;
            $(`#datum-${index} > :last-child`).append(`<span class="text-gray-500 font-serif"> v.s. </span>`);
            let new_div = `
                        ${datum.total_prediction ? 
                            "<div class='text-red-500 font-medium text-base rounded ml-1'>Remove</div>" : 
                            "<div class='text-emerald-500 font-medium text-base rounded ml-1'>Approve</div>"
                        }
                    `;

            // Append the new div to the last child div of the current datum div
            $(`#datum-${index} > :last-child`).append(new_div);
            $(`#datum-${index}`).addClass(datum.label == datum.total_prediction ? "" : "bg-rose-100");
        });
         
        let performance = results.performance;
        if(STAGE === "build"){
            $('#test-accuracy').text(to_percentage(performance.accuracy));
            $('#test-precision').text(to_percentage(performance.precision));
            $('#test-recall').text(to_percentage(performance.recall));
            $('#test-fpr').text(to_percentage(performance.fpr));
            $('#test-fnr').text(to_percentage(performance.fnr));
        } else if(STAGE === "update"){
            let build_performance = old_results.performance;
            console.log("build_performance", build_performance);
            // show texts like build_performance.acuracy --> update_performance.accuracy
            $('#test-accuracy').html(`${to_percentage(build_performance.accuracy)}<i class="fa-solid fa-arrow-right text-gray-400 fa-sm px-4"></i>${to_percentage(performance.accuracy)}`);
            $('#test-precision').html(`${to_percentage(build_performance.precision)}<i class="fa-solid fa-arrow-right text-gray-400 fa-sm px-4"></i>${to_percentage(performance.precision)}`);
            $('#test-recall').html(`${to_percentage(build_performance.recall)}<i class="fa-solid fa-arrow-right text-gray-400 fa-sm px-4"></i>${to_percentage(performance.recall)}`);
            $('#test-fpr').html(`${to_percentage(build_performance.fpr)}<i class="fa-solid fa-arrow-right text-gray-400 fa-sm px-4"></i>${to_percentage(performance.fpr)}`);
        }
    }

    function pollForResults(task_dict) {
        const pollInterval = 2000; // Poll every second
        Object.entries(task_dict).forEach(([name, task]) => {
            task.status = false; // false indicates incomplete
        });
        
        var poll = setInterval(function() {
            Object.entries(task_dict).forEach(([name, task]) => {
                if (task.status) return;
                $.ajax({
                    url: "/get_validate_results/", 
                    type: "GET",
                    data: {"participant_id": PARTICIPANT_ID, "stage": STAGE, "task_id": task.id, "old": name === "old"},
                    success: function(response) {
                        if (response["status"]) {
                            task.status = true;
                            task.results = response.data.test_results;
                            console.log(`Task ${task.id} is complete!`);

                            let all_tasks_complete = Object.values(task_dict).every(item => item.status === true);
                            if (all_tasks_complete) {
                                console.log("All tasks are complete!");
                                clearInterval(poll); // Stop polling since all tasks are complete
                                hideLoadingModal();
                                showResults(task_dict.now.results, task_dict.old?.results || null);
                            }
                        } else {
                            console.log("Task is still processing...");
                        }
                    },
                    error: function() {
                        console.error("Error polling for task results.");
                        clearInterval(poll); // Stop polling on error
                    }
                });                     
            });
        }, pollInterval);
    }

    $(document).ready(function(){
        let textList = $('#textList');
        // for testing purposes, use the score to simulate the user's label
        dataset.forEach((datum, index) => {
            let text_div_html = `
                <div id="datum-${index}" class="px-4 datum flex flex-row items-center justify-between gap-x-1 py-1 border-b border-gray-300">   
                    <div id="text-${index}" class="grow p-2">${escape_html(datum.text)}</div>
                    <div class="min-w-[20%] flex justify-end">
                        ${datum.label == 1 ? 
                            "<div class='text-red-500 font-medium text-base rounded mr-2'>Remove</div>" : 
                            "<div class='text-emerald-500 font-medium text-base rounded mr-2'>Approve</div>"
                        }
                    </div>
                </div>`;
            textList.append(text_div_html);
        });

        if(TASK_ID !== ""){
            if(STAGE === "build"){
                pollForResults({
                    now: {id: TASK_ID}
                });
            } else if(STAGE === "update"){
                let old_task_id = "{{old_task_id}}";
                pollForResults({
                    old: {id: old_task_id}, 
                    now: {id: TASK_ID}
                });
            }
            showLoadingModal("We are evaluating how your filter performs, so please wait for a moment.");
        } else {
            let test_results = JSON.parse(`{{test_results | safe}}`);
            let old_test_results = JSON.parse(`{{old_test_results | safe}}`);
            showResults(test_results, old_test_results);
        }     
    });

    


</script>
</html>