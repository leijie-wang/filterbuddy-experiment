{% load static %}

<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>System Validation</title>
  <!-- use bootstrap UI -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <!-- base layout -->
  <link rel="stylesheet" href="{% static 'css/sharedsteps.css' %}" />
  <script src="https://kit.fontawesome.com/95a71e9646.js" crossorigin="anonymous"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="{% static 'js/jquery-3.7.1.js'%}"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>

<body class="h-screen w-screen overflow-y-hidden flex flex-col">

    <!-- 
      The <noscript> tag encloses the content that will be displayed 
      only if JavaScript is disabled or not supported in the user's browser. 
    -->
    <noscript>
        If you see this text, your browser does not support dynamic content
        (JavaScript) or it has been disabled. This study website requires JavaScript.
    </noscript> 
    {% csrf_token %}

    <div x-data="{}" class="grow w-full flex flex-col gap-y-4 mb-10 px-4">
        <!-- display a list of comments to be reviewed -->
        <div class="header flex flex-col gap-y-4 items-stretch bg-slate-100 p-4 rounded">
            <p class="text-2xl font-semibold">Welcome to build your own word filters!</p>
            <p class="text-lg text-start font-sans">
                Thank you for your efforts in building your own filter. Remember that you have labeled some examples before?
                We compared your labels with the predictions of your filter and present its performance below.
            </p>
        </div>
        <div class="grow flex flex-row mx-4">
            <div class="self-stretch flex flex-col gap-y-2 w-2/3">
                <div class="grow-0 flex justify-start">
                    <div id="countDisplay" class="text-base text-blue-600"></div>
                </div>
                <!-- display a list of comments to be reviewed -->
                <div id="textList"
                    class="grow flex flex-col h-16 overflow-y-auto px-4 border border-gray-600 rounded"
                ></div>
            </div>
            <!-- display the results of algorithmic predictions -->
            <div class="mx-4 flex flex-col justify-between gap-y-8 w-1/3">         
                <div class="flex flex-col items-center">
                    <!-- Accuracy -->
                    <div class="flex items-center py-4 px-3 w-[80%] justify-evenly border-b border-gray-300">
                        <div class="text-slate-600 text-center text-2xl font-medium">Accuracy</div>
                        <span class="text-3xl" id="test-accuracy">?</span>
                    </div>
                    <!-- Precision -->
                    <div class="flex items-center py-4 px-3 w-[80%] justify-evenly border-b border-gray-300">
                        <div class="text-slate-600  text-center text-2xl font-medium">Precision</div>
                        <span class="text-3xl" id="test-precision">?</span>
                    </div>
                    <!-- Recall -->
                    <div class="flex items-center py-4 px-3 w-[80%] justify-evenly border-b border-gray-300">
                        <div class="text-slate-600  text-center text-2xl font-medium">Recall</div>
                        <span class="text-3xl" id="test-recall">?</span>
                    </div>
                    <!-- False Positive Rate -->
                    <div class="flex items-center py-4 px-3 w-[80%] justify-evenly border-b border-gray-300"> 
                        <div class="text-slate-600 text-2xl font-medium">False Positive Rate</div>
                        <span class="text-3xl" id="test-fpr">?</span>
                    </div>
                </div>
                {% if stage == "build" %}   
                    <div class="flex flex-col gap-y-4 bg-slate-100 rounded p-4">
                        <p class="text-lg">
                            Thanks for your efforts in labeling these examples. Now start building your own filters
                        </p>
                        <button 
                            class="text-white text-lg self-end bg-blue-600 px-4 py-2 rounded-lg"
                            @click="go_to_system();"
                        >
                            Improve your filter
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</body> <!-- closes container -->
<!-- custom js -->
<script src="{% static 'js/sharedsteps.js' %}" defer></script>
<script defer>
    const PARTICIPANT_ID = "{{participant_id}}";
    const SYSTEM = "{{system}}";
    const STAGE = "{{stage}}";
    const TEST_RESULTS = JSON.parse(`{{test_results | safe}}`);
    var dataset = JSON.parse(`{{dataset | safe}}`);

    var positive_number = 0;
    function change_label(index, new_label){
        dataset[index].label = new_label;
        // change the button color
        if(dataset[index].label){
            $(`#datum-${index} .yes-button`).removeClass('unselected-button').addClass('selected-button');
            $(`#datum-${index} .no-button`).removeClass('selected-button').addClass('unselected-button');
        } else {
            $(`#datum-${index} .no-button`).removeClass('unselected-button').addClass('selected-button');
            $(`#datum-${index} .yes-button`).removeClass('selected-button').addClass('unselected-button');

        }

        // update the number of positive examples
        positive_number = positive_number + (dataset[index].label ? 1 : 0);
        $('#positive-number').text(positive_number);
    }

    function go_to_system(){
        redirect("/onboarding/", {'participant_id': PARTICIPANT_ID});
    }

    $(document).ready(function(){
        
        let textList = $('#textList');
        // for testing purposes, use the score to simulate the user's label
        dataset.forEach((datum, index) => {
            // create a new div element for each text with the template below
            datum.total_prediction = TEST_RESULTS.prediction[index];
            datum.predictions = TEST_RESULTS.texts_predictions?.[index] || null; 
            // for some classifiers they do not have individual predictions

            let text_div_html = `
                <div id="datum-${index}" class="flex flex-row items-center space-x-1 py-1 border-b border-gray-300">   
                    <div id="text-${index}" class="grow w-[85%] p-2">${datum.text}</div>
                    <div class="flex-col items-stretch grow-0 font-bold w-[10%] text-center">
                        ${datum.label == 1 ? 
                            "<div class='w-full text-white bg-red-400 text-lg p-1 rounded'>Toxic</div>" : 
                            "<div class='w-full text-white bg-emerald-400 text-lg p-1 rounded'>No</div>"
                        }
                    </div>
                    <div class="flex-col items-stretch grow-0 font-bold w-[5%] text-center">
                        ${datum.label == datum.total_prediction ? 
                            "<span class='text-gray-500'><i class='fa-solid fa-check px-2 fa-xl'></i></span>" : 
                            "<span class='text-gray-500'><i class='fa-solid fa-xmark px-2 fa-xl'></i></span>"
                        }
                    </div>
                </div>`
            textList.append(text_div_html);
        });

        let performance = TEST_RESULTS.performance;
        $('#test-accuracy').text(to_percentage(performance.accuracy));
        $('#test-precision').text(to_percentage(performance.precision));
        $('#test-recall').text(to_percentage(performance.recall));
        $('#test-fpr').text(to_percentage(performance.fpr));
        $('#test-fnr').text(to_percentage(performance.fnr));
    });

    


</script>
</html>