{% load static %}

<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tell us your criteria</title>
  <!-- use bootstrap UI -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <!-- base layout -->
  <link rel="stylesheet" href="{% static 'css/sharedsteps.css' %}" />
  <script src="https://kit.fontawesome.com/95a71e9646.js" crossorigin="anonymous"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="{% static 'js/jquery-3.7.1.js'%}"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>

<body class="h-screen w-screen overflow-y-hidden flex flex-col">

    <!-- 
      The <noscript> tag encloses the content that will be displayed 
      only if JavaScript is disabled or not supported in the user's browser. 
    -->
    <noscript>
        If you see this text, your browser does not support dynamic content
        (JavaScript) or it has been disabled. This study website requires JavaScript.
    </noscript> 
    {% csrf_token %}

    <!-- display a list of comments to be reviewed -->
    <div x-data="{ atBottom: false }" class="grow w-full flex flex-col gap-y-2 mb-5 px-4">   
        <div class="grow-0 header flex flex-col gap-y-2 items-stretch bg-slate-100 p-4 rounded">
                {% if stage == "build" %}
                    <p class="text-2xl font-semibold">Build Your Filters!</p>
                    <p class="text-lg text-start font-sans">
                        To get started, we need your input. Please take a moment to label the following examples. 
                        The labels you provide will be used later to measure how well your filter performs. 
                        Your input is crucial for creating a filter that truly understands your preferences. Let's begin!
                    </p>
                {% elif stage == "update" %}
                    <p class="text-2xl font-semibold">Update Your Word Filters!</p>
                    <p class="text-lg text-start font-sans">
                        The world of social media is always changing, and so are the types of comments you see. <br/>
                        Before you update your word filter to these new trends, we need your help in labeling a fresh set of comments <br/>
                        Please label this new set of comments, which reflect recent trends. Your labels will help us evaluate the effectiveness of your updated filter 
                    </p>
                {% endif %}
        </div>
        <div class="grow flex mx-4 items-stretch">
            <div class="w-[70%] flex flex-col gap-y-2 items-start">

                <div id="countDisplay" class="grow-0 text-base italic text-blue-600"></div>

                <!-- display a list of comments to be reviewed -->
                <div id="textList"
                    @scroll="atBottom = $el.scrollHeight - $el.scrollTop - $el.clientHeight < 1"
                    class="grow flex flex-col px-4 border border-gray-600 rounded h-16 overflow-y-auto"
                ></div>
            </div>
            <div x-show="atBottom" class="w-[30%] flex flex-col justify-end items-center px-4">
                <div class="flex flex-col gap-y-2  bg-slate-100 rounded p-4">
                    <p class="text-lg">
                        {% if stage == "build" %}
                            Thanks for your efforts in labeling these examples. Now start building your filters
                        {% elif stage == "update" %}
                            Thanks for your efforts in labeling these examples. Now start updating your filters
                        {% endif %}
                    </p>
                    <button 
                        class="text-white text-2xl self-end bg-blue-600 px-4 py-2 rounded-lg"
                        
                        @click="go_to_system();"
                    >
                        GO!
                    </button>
                </div>
            </div>
        </div>
    </div>
</body> <!-- closes container -->
<!-- custom js -->
<script src="{% static 'js/sharedsteps.js' %}" defer></script>
<script defer>
    const PARTICIPANT_ID = "{{participant_id}}";
    const STAGE = "{{stage}}";

    var dataset = [];
    var positive_number = 0;
    var label_number = 0;

    function change_label(index, new_label){
        // change the label of the text at the given index
        label_number = label_number + (dataset[index].label == null ? 1 : 0);

        dataset[index].label = new_label;
        // change the button color
        if(dataset[index].label){
            $(`#datum-${index} .yes-button`).removeClass('unselected-button').addClass('selected-button');
            $(`#datum-${index} .no-button`).removeClass('selected-button').addClass('unselected-button');
        } else {
            $(`#datum-${index} .no-button`).removeClass('unselected-button').addClass('selected-button');
            $(`#datum-${index} .yes-button`).removeClass('selected-button').addClass('unselected-button');

        }

        // update the number of positive examples
        positive_number = positive_number + (dataset[index].label ? 1 : 0);
        $('#positive-number').text(positive_number);
        $('#label-number').text(label_number);

    }


    function go_to_system(){
        if(label_number < dataset.length){
            alert("Please label all the examples before proceeding");
            return;
        }

        post_backend(
            "/store_groundtruth/", {'dataset': dataset, 'participant_id': PARTICIPANT_ID, 'stage': STAGE},
            function(response) {
                // if the json response has the response code 200
                console.log(response);
                if (!response['status']) {
                    alert(response['message']);
                    return;
                }
                redirect("/load_system/", {'participant_id': PARTICIPANT_ID, 'stage': STAGE});
            }
        );
    }

    $(document).ready(function(){
        dataset = display_labeling_data(JSON.parse(`{{dataset | safe}}`), dataset, false);
        
        // for testing purposes, use the score to simulate the user's label
        dataset.forEach((datum, index) => {
            if(index >= 5){
                change_label(index, +parseFloat(datum.score) >= 0.5);
            }
        })
    });

    


</script>
</html>