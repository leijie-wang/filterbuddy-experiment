{% load static %}

<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Tell us your criteria</title>
    <!-- use bootstrap UI -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <!-- base layout -->
    <link rel="stylesheet" href="{% static 'css/sharedsteps.css' %}" />
    <script src="https://kit.fontawesome.com/95a71e9646.js" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="{% static 'js/jquery-3.7.1.js'%}"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="{% static 'js/utils.js' %}"></script>
    <script src="{% static 'js/base.js' %}"></script>
    <script src="{% static 'js/label.js' %}"></script>
</head>

<body class="flex flex-col py-3 px-4 h-screen w-screen overflow-y-hidden">

    <!-- 
      The <noscript> tag encloses the content that will be displayed 
      only if JavaScript is disabled or not supported in the user's browser. 
    -->
    <noscript>
        If you see this text, your browser does not support dynamic content
        (JavaScript) or it has been disabled. This study website requires JavaScript.
    </noscript> 
    {% csrf_token %}

    <!-- display a list of comments to be reviewed -->
    <div x-data="{ atBottom: false }" class="flex flex-col gap-y-4 h-full w-full pb-4">   
        <div class="grow-0 flex gap-x-2 items-stretch">
            <div class="grow flex flex-col gap-y-2 py-2 px-4 items-start justify-center bg-slate-100  rounded-md">
                {% if stage == "build" %}
                    <p class="text-2xl font-semibold">Set Your Filter's Goal</p>
                    <p class="text-xl text-start font-sans">
                       Before building your filter, please take a moment to label these comments as <span class="text-emerald-600 font-medium">Keep</span> or <span class="text-red-600 font-medium ">Remove</span>.
                       <br/> Your labels will be the gold standards for your filter to match. 
                       We'll use your labeled examples to assess how effectively your filter works. 
                    </p>
                {% elif stage == "update" %}
                    <p class="text-2xl font-semibold">Update Your Word Filters!</p>
                    <p class="text-lg text-start font-sans">
                        The world of social media is always changing, and so are the types of comments you see.
                        <br/> Before you update your word filter to these new trends, we need your help in labeling a fresh set of comments.
                        Please label this new set of comments, which reflect recent trends. Your labels will help us evaluate the effectiveness of your updated filter 
                    </p>
                {% endif %}
            </div>
            <div class="flex flex-col items-center justify-center">
                <div id="timer" class="flex items-center justify-center grow-0 text-3xl font-bold p-2 rounded-full border border-gray-500 aspect-square min-w-32">
                    15:00
                </div>
                <div class="text-base italic whitespace-nowrap">
                    minutes left
                </div>
            </div>
        </div>
        <div class="grow flex mx-4 items-stretch">
            <div class="grow-0 w-[70%] flex flex-col gap-y-2 items-stretch">

                <div id="countDisplay" class="grow-0 text-base italic text-blue-600"></div>

                <!-- display a list of comments to be reviewed -->
                <div id="textList"
                    @scroll="atBottom = $el.scrollHeight - $el.scrollTop - $el.clientHeight < 1"
                    class="grow flex flex-col px-4 border-2 !border-gray-500 rounded h-16 overflow-y-auto"
                ></div>
            </div>
            <div x-show="atBottom" class="grow-0 w-[30%] flex flex-col justify-end items-center px-4">
                <div class="flex flex-col gap-y-6 bg-slate-100 rounded p-4">
                    <p class="text-2xl">
                        {% if stage == "build" %}
                            Now start create your filter!       
                        {% elif stage == "update" %}
                            Now start updating your filter!
                        {% endif %}
                                        
                    </p>
                    <button 
                        class="text-white text-2xl self-end bg-blue-600 px-4 py-2 rounded-lg"
                        
                        @click="complete();"
                    >
                        Complete
                    </button>
                </div>
            </div>
        </div>
        <div id="alertModal"  class="hidden fixed inset-0 bg-slate-300 bg-opacity-50 overflow-y-auto h-full w-full">
            <div class="relative top-1/3 mx-auto py-8 px-4 border w-fit shadow-lg rounded-lg bg-white flex flex-col justify-between gap-y-8">
                <div id="alertModalText" class="grow text-start text-xl text-gray-600">
                    <!-- Your alert message here -->
                </div>
                <div class="self-end flex gap-x-4">
                    <button @click="hideAlertModal();" class="grow-0 text-white py-1 px-3 rounded bg-gray-400 hover:bg-gray-500 font-semibold text-lg">
                        Cancel
                    </button>
                    <button id="alertModalButton"
                        @click="nextAlertModal();" class="grow-0  text-white py-1 px-3 rounded bg-blue-400 hover:bg-blue-500 font-semibold text-lg">
                        Okay
                    </button>
                </div>
            </div>
        </div>
    </div>
    
</body> <!-- closes container -->
<!-- custom js -->
<script>
    PARTICIPANT_ID = "{{participant_id}}";
    STAGE = "{{stage}}";
    SYSTEM= "GroundTruth"

    function save_system(time_spent){
        let labeled_dataset = dataset.filter(datum => datum.label != null);
        post_backend(
            "/store_groundtruth/",
            {'dataset': labeled_dataset, 'participant_id': PARTICIPANT_ID, 'stage': STAGE},
            function(response) {
                if(!response["status"]){
                    console.warn(response["message"]);
                } else {
                    console.log(`Save the labeled groundtruths successfully at ${time_spent / 1000} seconds.`);
                }
            }
        ); 
    }
    function complete(timeout, exit=false){
        
        if(!exit){
            if(!timeout && (label_number < dataset.length)){
                // if users still have time but not all examples are labeled
                showAlertModal("Please label all the examples before proceeding");
                return;
            } else if(timeout && (label_number < dataset.length)){
                // if users run out of time but not all examples are labeled
                showAlertModal("Time's up! Please label all the examples before proceeding");
                return;
            }
            logEvents("Complete", {"positive_number": positive_number, "label_number": label_number});
            showAlertModal("Thank you for your efforts in labeling these examples. You can now proceed to the next step.", "Continue", () => complete(true, true));
            return;
        }
        
        post_backend(
                "/store_groundtruth/", {'dataset': dataset, 'participant_id': PARTICIPANT_ID, 'stage': STAGE, 'logs': logs},
                function(response) {
                    if(DEBUG) console.log(response);
                    if (!response['status']) {
                        showAlertModal(response['message']);
                        return;
                    }
                    redirect("/onboarding/", {'participant_id': PARTICIPANT_ID, 'stage': STAGE, 'system': SYSTEM});
                }
            );
    }
    

    $(document).ready(function(){
        
        displayLabelingData(JSON.parse(`{{dataset | safe}}`), false);
        startTimer(SESSION_TIME);
        logEvents("Start", {});
        if(DEBUG){
            // for testing purposes, use the score to simulate the user's label
            dataset.forEach((datum, index) => {
                if(index >= 0){
                    changeLabel(index, +parseFloat(datum.score) >= 0.5);
                }
            })
        }
    });

    /* function showResults(test_results, old_performance){
        let performance = test_results.performance;
        $('#test-accuracy').html(`${to_percentage(old_performance.accuracy)}<i class="fa-solid fa-arrow-right text-gray-400 fa-sm px-4"></i>${to_percentage(performance.accuracy)}`);
        $('#test-precision').html(`${to_percentage(old_performance.precision)}<i class="fa-solid fa-arrow-right text-gray-400 fa-sm px-4"></i>${to_percentage(performance.precision)}`);
        $('#test-recall').html(`${to_percentage(old_performance.recall)}<i class="fa-solid fa-arrow-right text-gray-400 fa-sm px-4"></i>${to_percentage(performance.recall)}`);
        $('#test-fpr').html(`${to_percentage(old_performance.fpr)}<i class="fa-solid fa-arrow-right text-gray-400 fa-sm px-4"></i>${to_percentage(performance.fpr)}`);
    }*/

    /* function test_filter(){
        complete_label(
            function(){
                post_backend(
                    "/test_filter/", 
                    {'dataset': dataset, 'participant_id': PARTICIPANT_ID, 'stage': STAGE},
                    function(response) {
                        // if the json response has the response code 200
                        console.log(response);
                        if (!response['status']) {
                            alert(response['message']);
                            return;
                        }
                        old_performance = response.data.old_performance;
                        if("test_results" in response.data){
                            show_results(response.data.test_results, old_performance);
                        }
                        
                    }
                );
            }
        );    
    } */


</script>
</html>