{% load static %}

<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Example Labeler</title>
  <!-- use bootstrap UI -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <!-- base layout -->
  <link rel="stylesheet" href="{% static 'css/sharedsteps.css' %}" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="{% static 'js/jquery-3.7.1.js'%}"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>

<body class="container h-screen overflow-y-hidden">

    <!-- 
      The <noscript> tag encloses the content that will be displayed 
      only if JavaScript is disabled or not supported in the user's browser. 
    -->
    <noscript>
        If you see this text, your browser does not support dynamic content
        (JavaScript) or it has been disabled. This study website requires JavaScript.
    </noscript> 
    {% csrf_token %}

    <div x-data="{}" class="flex flex-col my-2 justify-start gap-y-4 py-4 h-screen">
        <div class="mx-auto pb-1 h-fit flex-grow-0">
            <h1 class="text-3xl font-semibold text-gray-800">Welcome to the Example Labeler</h1>
        </div>

        <!-- display a list of comments to be reviewed -->
        <div class="flex flex-col h-5/6 gap-y-2 flex-grow">
            <!-- display a set of filter options -->
            <div class="header flex justify-between">
                <label class="flex gap-2">
                    <input type="checkbox" id="yesFilter" class="form-checkbox">
                    <span class="font-bold">Show Only Toxic Comments</span>
                </label>
                <div id="countDisplay" class="text-base"></div>
            </div>
            <!-- display a list of comments to be reviewed -->
            <div id="textList"
                class="body flex flex-col overflow-y-auto py-4 px-4 border border-gray-600 rounded h-full">
            </div>
            <div class="bottom flex justify-end gap-x-2">
                <button @click="load_more_data" class="bg-stone-200 font-bold py-2 px-3 rounded" >
                    Load More Examples
                </button>
                <button id="complete-button" class="bg-green-600 text-white font-bold py-2 px-3 rounded">
                    Complete
                </button>
            </div>
        </div>

        <div id="loadingModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
            <div class="relative top-1/3 mx-auto p-5 border w-fit shadow-lg rounded-md bg-white">
                <div id="loadingModalText" class="text-center text-xl">
                    Loading...
                </div>
            </div>
        </div>
    </div>
</body> <!-- closes container -->
<!-- custom js -->
<script src="{% static 'js/sharedsteps.js' %}" defer></script>
<script defer>
    const COMPLETE_DATASET = JSON.parse(`{{dataset | safe}}`);
    const BATCH_SIZE = 30;
    const PARTICIPANT_ID = "{{participant_id}}";
    const SYSTEM = "{{system}}";
    const STAGE = "{{stage}}";

    var dataset = [];
    // the current batch of data that is loaded
    var current_batch = 0; 
    // whether the user wants to see only the toxic comments
    var yes_filtered = false;
    // how many examples are labeled as toxic
    var positive_number = 0;
    // how many examples are labeled
    var label_number = 0;

    $("#yesFilter").change(function(){
        
        yes_filtered = $(this).is(":checked");
        if(yes_filtered){
            dataset.forEach((datum, index) => {
                if(datum.label == true) 
                    $(`#datum-${index}`).show();
                else
                    $(`#datum-${index}`).hide();
                    
            });
        } else {
            dataset.forEach((datum, index) => {
                $(`#datum-${index}`).show();
            });
        }
    });


    function change_label(index, new_label){
        // change the label of the text at the given index
        label_number = label_number + (dataset[index].label == null ? 1 : 0);

        dataset[index].label = new_label;
        
        // change the button color
        if(dataset[index].label){
            $(`#datum-${index} .yes-button`).removeClass('unselected-button').addClass('selected-button');
            $(`#datum-${index} .no-button`).removeClass('selected-button').addClass('unselected-button');
        } else {
            $(`#datum-${index} .no-button`).removeClass('unselected-button').addClass('selected-button');
            $(`#datum-${index} .yes-button`).removeClass('selected-button').addClass('unselected-button');

        }

        // update the number of positive examples
        positive_number = positive_number + (dataset[index].label ? 1 : 0);
        $('#positive-number').text(positive_number);
        $('#label-number').text(label_number);

    }

    function load_more_data(new_separator=true){
        // load more data from the server
        /* get_backend(
            "/load_more_data/", 
            {'participant_id': participant_id},
            function(data){
                data = JSON.parse(data);
                console.log(`load ${data.length} new data`);
                dataset = display_labeling_data(data, dataset, true);
            }
        );*/

        let start = current_batch * BATCH_SIZE;
        let end = (current_batch + 1) * BATCH_SIZE;
        if(end >= COMPLETE_DATASET.length) end = COMPLETE_DATASET.length;
        let new_data = COMPLETE_DATASET.slice(start, end);
        dataset = display_labeling_data(new_data, dataset, new_separator);
        current_batch++;
        $('#countDisplay').html(`<span id="label-number">${label_number}</span> / ${dataset.length} labeled examples; <span id="positive-number">${positive_number}</span> example(s) labeled as toxic.`);
    }

    $('#complete-button').click( function(){
        // train the ML model
    
        // filter out the unlabeled data
        let labeled_dataset = dataset.filter(datum => datum.label != null);

        post_backend(
            "/store_labels/",
            {'dataset': labeled_dataset, 'participant_id': PARTICIPANT_ID, 'stage': STAGE},
            function(response) {
                $('#loadingModal').removeClass('hidden');
                $('#loadingModalText').text('We are evaluating the performance of your filters, please wait for a moment.');
                if(!response["status"]){
                    alert(response["message"]);
                    $('#loadingModal').addClass('hidden');
                } else {
                    redirect("/validate_page/", {'participant_id': PARTICIPANT_ID, 'system': SYSTEM, 'stage': STAGE});
                }
            }
        ); 
    });

    $(document).ready(function(){
        load_more_data(false);
        // for testing purposes, using labels in the dataset instead of manual labeling all the data
        dataset.forEach((datum, index) => {
            let new_label = +parseFloat(datum.score) >= 0.5;
            change_label(index, new_label);
        })

    });


</script>
</html>