{% load static %}

<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Example Labeler</title>
    <!-- use bootstrap UI -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <!-- base layout -->
    <link rel="stylesheet" href="{% static 'css/sharedsteps.css' %}" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="{% static 'js/jquery-3.7.1.js'%}"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="{% static 'js/utils.js' %}"></script>
    <script src="{% static 'js/base.js' %}"></script>
    <script src="{% static 'js/label.js' %}"></script>
</head>

<body class="flex flex-col py-3 px-4 h-screen w-screen overflow-y-hidden">

    <!-- 
      The <noscript> tag encloses the content that will be displayed 
      only if JavaScript is disabled or not supported in the user's browser. 
    -->
    <noscript>
        If you see this text, your browser does not support dynamic content
        (JavaScript) or it has been disabled. This study website requires JavaScript.
    </noscript>
    {% csrf_token %}

    <div x-data="{}" class="flex flex-col justify-start gap-y-4 h-full w-full">
        <div class="grow-0 flex gap-x-2 items-stretch">
            {% if tutorial %}
            <div class="grow flex items-center gap-x-8 bg-blue-50 p-3 rounded-md">
                <div class="grow-0 text-4xl font-bold text-sky-800 font-serif">
                    Tutorial
                </div>
                <div class="grow flex flex-col">
                    <div class="text-lg leading-8">
                        <p class="text-gray-600">
                            Do you know you can teach a filter to think like you? </br>
                            By labeling examples as <span class="text-emerald-600 font-medium">Keep</span> or <span class="text-red-600 font-medium ">Remove</span>, 
                            you're essentially teaching the filter to understand your standards. 
                        </p>
                        <p class="font-medium">
                            In the next step, please spend <span class="text-blue-600">3 minutes</span> first 
                            reading 
                            <a 
                                href="https://docs.google.com/presentation/d/1fxnL_I5yzO9LWeskBkrF8dWGK5MS6LDsh9jUTu2HsyE/edit#slide=id.p" 
                                class="text-blue-500 hover:text-blue-600 underline" target="_blank"
                            >the tutorial slides</a> 
                            and then exploring the interface.
                        </p>
                    </div>
                </div>
            </div>
            {% elif stage == "build" %}
            <div class="grow flex items-center gap-x-8 bg-green-50 p-3 rounded-md">
                <div class="grow-0 text-4xl font-bold text-emerald-800 font-serif">
                    Create
                </div>
                <div class="grow flex flex-col">
                    <div class="text-lg leading-8">
                        <p class="text-gray-600">
                            Do you know you can teach a filter to think like you? </br>
                            By labeling examples as <span class="text-emerald-600 font-medium">Keep</span> or <span class="text-red-600 font-medium ">Remove</span>, 
                            you're essentially teaching the filter to understand your standards. 
                        </p>
                        <p class="font-medium">
                            In the next, please take up to <span class="font-medium">15 minutes</span> to label new examples,
                            based on your personal preferences. <br/>Feel free to take your time. There's no need to rush.
                        </p>
                    </div>
                </div>
            </div>
            {% elif stage == "update" %}
            <div class="grow flex items-center gap-x-8 bg-yellow-50 p-3 rounded-md">
                <div class="grow-0 text-4xl font-bold text-orange-600 font-serif">
                    Update
                </div>
                <div class="grow flex flex-col">
                    <div class="text-lg leading-8">
                        <p class="text-gray-600">
                            Do you know you can teach a filter to think like you? </br>
                            By labeling examples as <span class="text-emerald-600 font-medium">Keep</span> or <span class="text-red-600 font-medium ">Remove</span>, 
                            you're essentially teaching the filter to understand your standards. 
                        </p>
                        <p class="font-medium">
                            In the next, please take up to <span class="font-medium">15 minutes</span> to label new examples,
                            based on your personal preferences. Please take your time -- don't worry if you don't have time to label all the examples.
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}
            <div class="flex flex-col items-center justify-center">
                <div id="timer" class="flex items-center justify-center grow-0 text-2xl font-bold p-2 rounded-full border-2 border-gray-500 aspect-square min-w-24 bg-white">
                    15:00
                </div>
                <div class="text-base italic whitespace-nowrap">
                    minutes left
                </div>
            </div>
        </div>

        <!-- display a list of comments to be reviewed -->
        <div class="flex flex-col h-[75%] gap-y-2 flex-grow">
            <!-- display a set of filter options -->
            <div class="header flex justify-between">
                <label class="flex gap-2">
                    <input type="checkbox" id="yesFilter" class="form-checkbox">
                    <span class="font-bold">Show only Comments labeled as "Remove"</span>
                </label>
                <div id="countDisplay" class="text-base"></div>
            </div>
            <!-- display a list of comments to be reviewed -->
            <div id="textList"
                class="body flex flex-col overflow-y-auto py-4 px-4 border-2 !border-gray-500 rounded h-full">
            </div>
            <div class="bottom flex justify-end gap-x-2">
                <button @click="loadMoreData(true, true);" class="bg-stone-200 font-bold py-2 px-3 rounded" >
                    Load More Examples
                </button>
                {% if tutorial %}
                <button @click="complete()" class="bg-green-600 text-white font-bold py-2 px-3 rounded">
                    Finish the Tutorial
                </button>
                {% else %}
                <button id="createFilterButton" @click="complete()" class="hidden bg-green-600 text-white font-bold py-2 px-3 rounded opacity-50 cursor-not-allowed">
                    Create your Filter
                </button>
                {% endif %}
            </div>
        </div>

        <div id="loadingModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
            <div class="relative top-1/3 mx-auto p-5 border w-fit shadow-lg rounded-md bg-white">
                <div id="loadingModalText" class="text-start text-xl text-gray-600">
                    Loading...
                </div>
            </div>
        </div>
        <div id="alertModal"  class="hidden fixed inset-0 bg-slate-300 bg-opacity-50 overflow-y-auto h-full w-full">
            <div class="relative top-1/3 mx-auto py-8 px-4 border w-fit shadow-lg rounded-lg bg-white flex flex-col justify-between gap-y-8">
                <div id="alertModalText" class="grow text-start text-xl text-gray-600">
                    <!-- Your alert message here -->
                </div>
                <div class="self-end flex gap-x-4">
                    <button @click="hideAlertModal();" class="grow-0 text-white py-1 px-3 rounded bg-gray-400 hover:bg-gray-500 font-semibold text-lg">
                        Cancel
                    </button>
                    <button id="alertModalButton"
                        @click="nextAlertModal();" class="grow-0  text-white py-1 px-3 rounded bg-blue-400 hover:bg-blue-500 font-semibold text-lg">
                        Okay
                    </button>
                </div>
            </div>
        </div>
    </div>
</body> <!-- closes container -->
<!-- custom js -->

<script defer>
    /* experiment parameters */
    PARTICIPANT_ID = "{{participant_id}}";
    STAGE = "{{stage}}";
    SYSTEM = "{{system}}";
    TUTORIAL = "{{ tutorial }}" == "True";
    DEBUG = "{{debug}}" === "True"
    
    const ACTIVE_LEARNING = true;
    /* which examples have already been displayed */
    var excluded_ids = JSON.parse(`{{excluded_ids | safe}}`);
    
    /* display labeling statistics */    
    var yes_filtered = false; // whether the user wants to see only the toxic comments

    $("#yesFilter").change(function(){
        logEvents("Filter", {"checked": $(this).is(":checked")});
        
        yes_filtered = $(this).is(":checked");
        if(yes_filtered){
            dataset.forEach((datum, index) => {
                if(datum.label == true) 
                    $(`#datum-${index}`).show();
                else
                    $(`#datum-${index}`).hide();
            });
        } else {
            dataset.forEach((datum, index) => {
                $(`#datum-${index}`).show();
            });
        }
    });

    async function loadMoreData(new_separator=true, active_learning=true){
        // check that the user has labeled all existing examples
        if(label_number < dataset.length){
            showAlertModal("Please label all the examples before loading more.");
            return;
        }
        let new_data = [];
        if(dataset.length === 0){
            new_data = JSON.parse(`{{dataset | safe}}`);
        } else {
            showLoadingModal("Loading more examples...");
            try {
                let response = await post_backend(
                    "/active_learning/", 
                    {
                        'participant_id': PARTICIPANT_ID, 'stage': STAGE, 
                        "active_learning": ACTIVE_LEARNING, 'dataset': dataset, 
                        "excluded_ids": excluded_ids, "tutorial": TUTORIAL
                    },
                )
                if(response["status"]){
                    new_data = response.data.next_batch;
                    new_ids = new_data.map(datum => datum.datum_id);
                    excluded_ids = excluded_ids.concat(new_ids);
                } else {
                    showAlertModal(response["message"]);
                }
            } catch (error) {
                console.error(error);
            }
        } 

        
        logEvents("LoadExamples", {"active_learning": active_learning, "dataset_len": new_data.length});
        console.log(new_data.length);
        displayLabelingData(new_data, new_separator);
        console.log(`positive_number: ${positive_number}, label_number: ${label_number}`);
        $('#countDisplay').html(`<span id="label-number">${label_number}</span> / ${dataset.length} labeled examples; <span id="positive-number">${positive_number}</span> example(s) labeled as "Remove".`);
        
        hideLoadingModal();
        
        
    }

    function save_system(time_spent){
        let labeled_dataset = dataset.filter(datum => datum.label != null);
        post_backend(
            "/store_labels/",
            {'dataset': labeled_dataset, 'participant_id': PARTICIPANT_ID, 'stage': STAGE, time_spent: time_spent},
            function(response) {
                if(!response["status"]){
                    console.warn(response["message"]);
                } else {
                    console.log(`Save the labeled examples successfully at ${time_spent / 1000} seconds.`);
                }
            }
        ); 
    }

    function complete(timeout=false, exit=false){
        if(TUTORIAL){
            if(!exit && !timeout){
                showAlertModal("You still have time for your tutorial. Are you sure that you want to skip the tutorial?", "Yes", () => complete(timeout, true));
                return;
            } 
            redirect("/load_system/", {'participant_id': PARTICIPANT_ID, 'debug': DEBUG});
            return;
        }

        if(label_number === positive_number || positive_number === 0 || label_number === 0){
            showAlertModal("You should label at least one example as 'Remove' and one example as 'Keep' before creating your filter.");
            return;
        }
        
        /* store the labeled examples and then redirect to the validation page where an ML model will be trained */
        if(!exit && !timeout){
            showAlertModal("You still have time to label more examples. Are you sure that you want to create your filter now?", "Yes", () => complete(timeout, true));
            return;
        } 

        if(timeout){
            message = "This session ends. Thank you for your time. We are now evaluating how your filter performs, so please wait for a moment.";
        } else {
            message = "We are evaluating how your filter performs, so please wait for a moment.";
        }
        showLoadingModal(message);

        logEvents("Complete", {"positive_number": positive_number, "label_number": label_number});

        // filter out the unlabeled data， at this point, we do not require users to label all the examples they have loaded
        let labeled_dataset = dataset.filter(datum => datum.label != null);
        post_backend(
            "/store_labels/",
            {'dataset': labeled_dataset, 'participant_id': PARTICIPANT_ID, 'stage': STAGE, 'logs': logs, time_spent: time_spent},
            function(response) {
                if(!response["status"]){
                    hideLoadingModal();
                    showAlertModal(response["message"]);
                } else {
                    // we do not hide the loading modal here, because redirecting to the validation page will take some time
                    redirect("/validate_page/", {'participant_id': PARTICIPANT_ID, 'system': SYSTEM, 'stage': STAGE, "debug": DEBUG});
                }
            }
        ); 
    }

    $(document).ready(function(){
        time_spent = parseInt("{{time_spent}}");
        if(TUTORIAL){
            startTimer(TUTORIAL_TIME)
        } else {
            startTimer(SESSION_TIME);
        }
        
        logEvents("Start", {});
        loadMoreData(false);


        if(TUTORIAL || DEBUG || time_spent > (MUST_SPENT_TIME * 60 * 1000)){
            $('#createFilterButton').removeClass("hidden").removeClass('opacity-50 cursor-not-allowed').addClass('hover:bg-green-700');
        } else {
            setTimeout(function() {
                $('#createFilterButton').removeClass("hidden").removeClass('opacity-50 cursor-not-allowed').addClass('hover:bg-green-700');
            }, MUST_SPENT_TIME * 60 * 1000 - time_spent);
        }
            
    });


</script>
</html>