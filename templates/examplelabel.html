{% load static %}

<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Example Labeler</title>
    <!-- use bootstrap UI -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <!-- base layout -->
    <link rel="stylesheet" href="{% static 'css/sharedsteps.css' %}" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="{% static 'js/jquery-3.7.1.js'%}"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="{% static 'js/base.js' %}"></script>
    <script src="{% static 'js/label.js' %}"></script>
    <script src="{% static 'js/sharedsteps.js' %}"></script>
</head>

<body class="flex flex-col py-3 px-4 h-screen w-screen overflow-y-hidden">

    <!-- 
      The <noscript> tag encloses the content that will be displayed 
      only if JavaScript is disabled or not supported in the user's browser. 
    -->
    <noscript>
        If you see this text, your browser does not support dynamic content
        (JavaScript) or it has been disabled. This study website requires JavaScript.
    </noscript>
    {% csrf_token %}

    <div x-data="{}" class="flex flex-col justify-start gap-y-4 h-full w-full">
        <div class="flex-grow-0 flex gap-x-2 items-stretch">
            
            <div class="flex items-center justify-start bg-slate-100 p-3 rounded-md">
                <div class="text-xl text-black">
                    Do you know you can teach a filter to think like you? 
                    By labeling examples as <span class="text-emerald-600 font-medium">Keep</span> or <span class="text-red-600 font-medium ">Remove</span>, 
                    you're essentially teaching the filter to understand your standards.
                    In the next, please take up to <span class="font-medium">15 minutes</span> to label the provided examples as accurately as possible, based on what you feel fits your criteria.
                </div>
            </div>
            <div class="flex flex-col items-center justify-center">
                <div id="timer" class="flex items-center justify-center grow-0 text-2xl font-bold p-2 rounded-full border border-gray-500 aspect-square min-w-24">
                    15:00
                </div>
                <div class="text-base italic whitespace-nowrap">
                    minutes left
                </div>
            </div>
        </div>

        <!-- display a list of comments to be reviewed -->
        <div class="flex flex-col h-[75%] gap-y-2 flex-grow">
            <!-- display a set of filter options -->
            <div class="header flex justify-between">
                <label class="flex gap-2">
                    <input type="checkbox" id="yesFilter" class="form-checkbox">
                    <span class="font-bold">Show only Comments labeled as "Remove"</span>
                </label>
                <div id="countDisplay" class="text-base"></div>
            </div>
            <!-- display a list of comments to be reviewed -->
            <div id="textList"
                class="body flex flex-col overflow-y-auto py-4 px-4 border border-gray-600 rounded h-full">
            </div>
            <div class="bottom flex justify-end gap-x-2">
                <button @click="loadMoreData(true, true);" class="bg-stone-200 font-bold py-2 px-3 rounded" >
                    Load More Examples
                </button>
                <button @click="complete()" class="bg-green-600 text-white font-bold py-2 px-3 rounded">
                    Create your Filter
                </button>
            </div>
        </div>

        <div id="loadingModal" class="hidden fixed inset-0 bg-slate-300 !bg-opacity-50 overflow-y-auto h-full w-full">
            <div class="relative top-1/3 mx-auto py-8 px-4 border w-fit shadow-lg rounded-lg bg-white">
                <div id="loadingModalText" class="text-center text-xl font-semibold">
                    Loading...
                </div>
            </div>
        </div>
        <div id="alertModal"  class="hidden fixed inset-0 bg-slate-300 bg-opacity-50 overflow-y-auto h-full w-full">
            <div class="relative top-1/3 mx-auto py-8 px-4 border w-fit shadow-lg rounded-lg bg-white flex flex-col justify-between gap-y-8">
                <div id="alertModalText" class="grow text-center text-xl">
                    <!-- Your alert message here -->
                </div>
                <button 
                    @click="hideAlertModal();" 
                    class="grow-0 self-end text-white py-1 px-3 rounded bg-blue-400 hover:bg-blue-500 font-semibold text-lg"
                >
                    Okay
                </button>
            </div>
        </div>
    </div>
</body> <!-- closes container -->
<!-- custom js -->

<script defer>
    /* experiment parameters */
    SYSTEM = "{{system}}";

    const ACTIVE_LEARNING = true;
    const PARTICIPANT_ID = "{{participant_id}}";
    const STAGE = "{{stage}}";
    
    /* which examples have already been displayed */
    var excluded_ids = JSON.parse(`{{excluded_ids | safe}}`);
    
    /* display labeling statistics */    
    var yes_filtered = false; // whether the user wants to see only the toxic comments

    $("#yesFilter").change(function(){
        addLog(`[${SYSTEM}: Filter] User changed the filter to ${$(this).is(":checked") ? "show only toxic comments" : "show all comments"}.`);
        yes_filtered = $(this).is(":checked");
        if(yes_filtered){
            dataset.forEach((datum, index) => {
                if(datum.label == true) 
                    $(`#datum-${index}`).show();
                else
                    $(`#datum-${index}`).hide();
            });
        } else {
            dataset.forEach((datum, index) => {
                $(`#datum-${index}`).show();
            });
        }
    });

    async function loadMoreData(new_separator=true, active_learning=true){
        // check that the user has labeled all existing examples
        if(label_number < dataset.length){
            showAlertModal("Please label all the examples before loading more.");
            return;
        }
        let new_data = [];
        if(dataset.length === 0){
            new_data = JSON.parse(`{{dataset | safe}}`);
        } else {
            showLoadingModal("Loading more examples...");
            try {
                let response = await post_backend(
                    "/active_learning/", 
                    {'participant_id': PARTICIPANT_ID, 'stage': STAGE, "active_learning": ACTIVE_LEARNING, 'dataset': dataset, "excluded_ids": excluded_ids},
                )
                if(response["status"]){
                    new_data = response.data.next_batch;
                    new_ids = new_data.map(datum => datum.id);
                    excluded_ids = excluded_ids.concat(new_ids);
                } else {
                    showAlertModal(response["message"]);
                }
            } catch (error) {
                console.error(error);
            }
        } 

        addLog(`[ExampleLabel: LoadExamples] Loaded another batch of ${new_data.length} examples.`);

        displayLabelingData(new_data, new_separator);
        $('#countDisplay').html(`<span id="label-number">${label_number}</span> / ${dataset.length} labeled examples; <span id="positive-number">${positive_number}</span> example(s) labeled as "Remove".`);
        
        hideLoadingModal();
        
        if(DEBUG){
            // for testing purposes, using labels in the dataset instead of manual labeling all the data
            dataset.forEach((datum, index) => {
                if(index >= 0) {
                    let new_label = +parseFloat(datum.score) >= 0.5;
                    changeLabel(index, new_label);
                }
            });
        }
    }

    function complete(timeout=false){
        /* store the labeled examples and then redirect to the validation page where an ML model will be trained */
        
        if(timeout){
            message = "This session ends. Thank you for your time. We are now evaluating how your filter performs, so please wait for a moment.";
        } else {
            message = "We are evaluating how your filter performs, so please wait for a moment.";
        }

        showLoadingModal(message);

        addLog(`[ExampleLabel: Complete] Finished labeling groundtruth examples with ${positive_number} positive examples out of ${label_number} labeled examples.`);

        // filter out the unlabeled dataï¼Œ at this point, we do not require users to label all the examples they have loaded
        let labeled_dataset = dataset.filter(datum => datum.label != null);
        console.log("logs", logs.slice(0, 5));
        post_backend(
            "/store_labels/",
            {'dataset': labeled_dataset, 'participant_id': PARTICIPANT_ID, 'stage': STAGE, 'logs': logs},
            function(response) {
                if(!response["status"]){
                    hideLoadingModal();
                    showAlertModal(response["message"]);
                } else {
                    // we do not hide the loading modal here, because redirecting to the validation page will take some time
                    addLog(`[ExampleLabel: StoreLabels] Successfully stored the labeled examples and then redirected to the validation page.`);
                    redirect("/validate_page/", {'participant_id': PARTICIPANT_ID, 'system': SYSTEM, 'stage': STAGE});
                }
            }
        ); 
    }

    $(document).ready(function(){
        startTimer(15);
        addLog(`[ExampleLabel: Start] Users loaded the page to label examples.`);
        loadMoreData(false);
    });


</script>
</html>